<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>MatteoShare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --accent: #4cc9f0;
      --accent-soft: rgba(76,201,240,0.15);
      --accent-strong: #f72585;
      --text: #f5f5f5;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --border: #1f2933;
      --card-radius: 14px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
      --shadow-hard: 0 0 0 1px rgba(255,255,255,0.02);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #111827 0, #020617 40%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 32px;
      width: 100%;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #f72585 0, #7209b7 40%, #3a0ca3 70%, #030712 100%);
      box-shadow: 0 0 25px rgba(247,37,133,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      letter-spacing: 0.04em;
      font-size: 18px;
    }
    .brand-text-title {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 18px;
      text-transform: uppercase;
    }
    .brand-text-sub {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.3);
      font-size: 11px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.4));
      backdrop-filter: blur(10px);
    }
    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 10px rgba(74,222,128,0.8);
    }
    nav {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top left, rgba(148,163,184,0.18), rgba(15,23,42,0.9));
      color: var(--muted);
      font-size: 12px;
      padding: 7px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease-out;
    }
    .tab-btn span.icon {
      font-size: 13px;
    }
    .tab-btn.active {
      color: var(--text);
      border-color: rgba(76,201,240,0.9);
      box-shadow: 0 0 0 1px rgba(76,201,240,0.4), 0 0 25px rgba(76,201,240,0.35);
      background: radial-gradient(circle at top left, rgba(76,201,240,0.25), rgba(15,23,42,0.95));
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: minmax(0, 1fr); }
    }
    .card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(3,7,18,0.98));
      border-radius: var(--card-radius);
      border: 1px solid rgba(15,23,42,0.9);
      box-shadow: var(--shadow-soft), var(--shadow-hard);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top, rgba(76,201,240,0.08), transparent 60%);
      opacity: 0.7;
      pointer-events: none;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title-pill {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .card-body {
      position: relative;
      z-index: 1;
      font-size: 13px;
      color: #e5e7eb;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
      background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.4));
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(76,201,240,0.8);
    }
    .files-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }
    .files-table thead {
      background: linear-gradient(90deg, rgba(15,23,42,0.9), rgba(15,23,42,0.6));
    }
    .files-table th,
    .files-table td {
      padding: 6px 7px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .files-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }
    .files-table tbody tr {
      cursor: pointer;
      transition: background 0.12s ease-out;
    }
    .files-table tbody tr:hover {
      background: rgba(15,23,42,0.9);
    }
    .files-table tbody tr.selected {
      background: rgba(76,201,240,0.12);
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
    }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148,163,184,0.9);
    }
    .tag.safe .tag-dot { background: var(--success); }
    .tag.warn .tag-dot { background: #facc15; }
    .tag.danger .tag-dot { background: var(--danger); }
    .file-detail {
      display: none;
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(3,7,18,0.98));
    }
    .file-detail.visible { display: block; }
    .file-detail-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .file-detail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--muted);
    }
    .file-detail-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top left, rgba(76,201,240,0.2), rgba(15,23,42,0.95));
      color: var(--text);
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
    }
    .btn:hover {
      box-shadow: 0 0 0 1px rgba(76,201,240,0.5), 0 0 20px rgba(76,201,240,0.35);
      transform: translateY(-0.5px);
    }
    .btn.secondary {
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(15,23,42,0.7));
    }
    .btn.danger {
      border-color: rgba(248,113,113,0.7);
      background: radial-gradient(circle at top left, rgba(248,113,113,0.2), rgba(15,23,42,0.95));
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.4));
    }
    .status-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 10px rgba(74,222,128,0.8);
    }
    .status-pill-dot.offline {
      background: #f97373;
      box-shadow: 0 0 10px rgba(248,113,113,0.8);
    }
    .status-pill-dot.syncing {
      background: #facc15;
      box-shadow: 0 0 10px rgba(250,204,21,0.8);
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 260px;
    }
    .chat-messages {
      flex: 1;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(3,7,18,0.98));
      padding: 8px;
      overflow-y: auto;
      font-size: 12px;
    }
    .chat-message {
      margin-bottom: 6px;
      padding: 5px 7px;
      border-radius: 8px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }
    .chat-message-header {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .chat-message-user {
      font-weight: 600;
      color: #e5e7eb;
    }
    .chat-input-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .input,
    .select {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      font-size: 12px;
      padding: 6px 10px;
      outline: none;
      width: 100%;
    }
    .input::placeholder {
      color: rgba(148,163,184,0.7);
    }
    .select {
      padding-right: 26px;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
      margin-top: 6px;
    }
    @media (max-width: 700px) {
      .settings-grid { grid-template-columns: minmax(0, 1fr); }
    }
    .settings-item-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .settings-note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .chip {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .news-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
      font-size: 12px;
    }
    .news-item {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.95);
    }
    .news-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .news-meta {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 2px;
    }
    .news-body {
      font-size: 12px;
      color: #e5e7eb;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="brand">
      <div class="brand-logo">MS</div>
      <div>
        <div class="brand-text-title">MATTEOSHARE</div>
        <div class="brand-text-sub" id="brandSubtitle">SOCIAL 3.0 ¬∑ SMART AUTO UPDATE</div>
      </div>
    </div>
    <div class="pill">
      <span class="pill-dot"></span>
      <span id="statusOnlineLabel">Sistema online</span>
    </div>
  </header>

  <nav>
    <button class="tab-btn active" data-tab="files">
      <span class="icon">üìÇ</span><span id="tabFilesLabel">File</span>
    </button>
    <button class="tab-btn" data-tab="news">
      <span class="icon">üì∞</span><span id="tabNewsLabel">News</span>
    </button>
    <button class="tab-btn" data-tab="social">
      <span class="icon">üí¨</span><span id="tabSocialLabel">Social 3.0</span>
    </button>
    <button class="tab-btn" data-tab="settings">
      <span class="icon">‚öôÔ∏è</span><span id="tabSettingsLabel">Impostazioni</span>
    </button>
  </nav>

  <div class="layout">
    <!-- LEFT COLUMN -->
    <div>
      <!-- FILES CARD -->
      <section class="card tab-panel" data-tab-panel="files">
        <div class="card-header">
          <div class="card-title">
            <span>Archivio File</span>
            <span class="card-title-pill" id="filesSubtitle">Migliorare la grafica ¬∑ Sicurezza ¬∑ Auto update</span>
          </div>
          <span class="badge">
            <span class="badge-dot"></span>
            <span id="filesBadgeLabel">Foglio Google collegato</span>
          </span>
        </div>
        <div class="card-body">
          <div class="status-bar">
            <div class="status-pill" id="syncStatusPill">
              <span class="status-pill-dot syncing" id="syncStatusDot"></span>
              <span id="syncStatusText">Sincronizzazione intelligente in corso‚Ä¶</span>
            </div>
            <div style="font-size:11px;">
              <span id="filesCountLabel">File caricati:</span>
              <span id="filesCountValue">0</span>
            </div>
          </div>

          <table class="files-table" id="filesTable">
            <thead>
            <tr>
              <th id="thName">Nome</th>
              <th id="thCategory">Categoria</th>
              <th id="thSize">Peso</th>
              <th id="thSecurity">Sicurezza</th>
            </tr>
            </thead>
            <tbody id="filesTableBody">
            <!-- Popolato da JS -->
            </tbody>
          </table>

          <div class="file-detail" id="fileDetail">
            <div class="file-detail-title" id="fileDetailName">Seleziona un file‚Ä¶</div>
            <div class="file-detail-meta">
              <span id="fileDetailCategory"></span>
              <span id="fileDetailSize"></span>
              <span id="fileDetailHash"></span>
              <span id="fileDetailSecurity"></span>
            </div>
            <div id="fileDetailNotes" style="font-size:12px; margin-bottom:6px;"></div>
            <div class="file-detail-actions">
              <button class="btn" id="fileDownloadBtn">
                ‚¨áÔ∏è <span id="downloadBtnLabel">Scarica file</span>
              </button>
              <button class="btn secondary" id="fileOpenUrlBtn">
                üåê <span id="openLinkBtnLabel">Apri link diretto</span>
              </button>
              <button class="btn danger" id="fileReportBtn">
                üö© <span id="reportBtnLabel">Segnala file</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- NEWS CARD -->
      <section class="card tab-panel hidden" data-tab-panel="news">
        <div class="card-header">
          <div class="card-title">
            <span id="newsTitle">News & Aggiornamenti</span>
            <span class="card-title-pill" id="newsSubtitle">Aggiornamenti Social ¬∑ Sicurezza ¬∑ Funzioni</span>
          </div>
          <span class="badge">
            <span class="badge-dot"></span>
            <span id="newsBadgeLabel">News automatiche</span>
          </span>
        </div>
        <div class="card-body">
          <div class="news-list" id="newsList">
            <!-- Esempio statico, puoi collegare un altro Google Sheets se vuoi -->
            <div class="news-item">
              <div class="news-title" id="newsItem1Title">Social 3.0 attivo</div>
              <div class="news-meta" id="newsItem1Meta">Sistema di chat globale collegato a Google Sheets</div>
              <div class="news-body" id="newsItem1Body">
                La chat globale ora scrive e legge direttamente dal tuo foglio Google, con aggiornamento automatico intelligente.
              </div>
            </div>
            <div class="news-item">
              <div class="news-title" id="newsItem2Title">Sistema di aggiornamento automatico ‚Äúintelligente‚Äù</div>
              <div class="news-meta" id="newsItem2Meta">Rilevamento cambiamenti sul foglio file</div>
              <div class="news-body" id="newsItem2Body">
                L‚Äôarchivio file si aggiorna da solo quando rileva modifiche sul foglio, senza ricaricare l‚Äôintero sito.
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <!-- SOCIAL 3.0 / CHAT GLOBALE -->
      <section class="card tab-panel" data-tab-panel="social">
        <div class="card-header">
          <div class="card-title">
            <span id="socialTitle">Social 3.0 ¬∑ Chat Globale</span>
            <span class="card-title-pill" id="socialSubtitle">Collegata a Google Sheets</span>
          </div>
          <span class="badge">
            <span class="badge-dot"></span>
            <span id="socialBadgeLabel">Chat globale attiva</span>
          </span>
        </div>
        <div class="card-body">
          <div class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-row">
              <input class="input" id="chatUserInput" placeholder="Nome utente (es. Matteo)">
              <input class="input" id="chatMessageInput" placeholder="Scrivi un messaggio globale‚Ä¶">
              <button class="btn" id="chatSendBtn">‚û§</button>
            </div>
            <div class="status-bar">
              <div class="status-pill" id="chatStatusPill">
                <span class="status-pill-dot" id="chatStatusDot"></span>
                <span id="chatStatusText">Chat globale connessa</span>
              </div>
              <div style="font-size:11px;">
                <span id="chatMessagesCountLabel">Messaggi:</span>
                <span id="chatMessagesCountValue">0</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="card tab-panel hidden" data-tab-panel="settings">
        <div class="card-header">
          <div class="card-title">
            <span id="settingsTitle">Impostazioni</span>
            <span class="card-title-pill" id="settingsSubtitle">Lingua ¬∑ Social 3.0 ¬∑ Sistema</span>
          </div>
          <span class="badge">
            <span class="badge-dot"></span>
            <span id="settingsBadgeLabel">Profilo locale</span>
          </span>
        </div>
        <div class="card-body">
          <div class="settings-grid">
            <div>
              <div class="settings-item-label" id="settingsLanguageLabel">Lingua interfaccia</div>
              <select class="select" id="languageSelect">
                <option value="it">Italiano (predefinito)</option>
                <option value="en">English</option>
                <option value="ro">Rom√¢nƒÉ</option>
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
              </select>
              <div class="settings-note" id="settingsLanguageNote">
                La lingua cambia solo l‚Äôinterfaccia, non i contenuti dei file o della chat.
              </div>
            </div>
            <div>
              <div class="settings-item-label" id="settingsSystemLabel">Sistema</div>
              <div class="chips">
                <span class="chip" id="chipAutoUpdate">Auto update intelligente</span>
                <span class="chip" id="chipSocial">Social 3.0</span>
                <span class="chip" id="chipSecurity">Monitor sicurezza</span>
              </div>
              <div class="settings-note" id="settingsSystemNote">
                Il sistema controlla periodicamente il foglio Google per aggiornare file, news e chat senza ricaricare la pagina.
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const GOOGLE_SHEETS_FILES_URL = "INSERISCI_QUI_LA_TUA_URL_DI_EXPORT_JSON_O_GVIZ_PER_I_FILE";
  const GLOBAL_CHAT_ENDPOINT = "https://script.google.com/macros/s/AKfycbxMfTpIoNC6VVsFNO5JjX8SX0vwVFz2wLrTFRxcNlO6Kk8kA-hOZiJ1V3j0NJFKt_3F1A/exec";
  const FILE_REPORT_EMAIL = "report@matteoshare.local"; // cambia questo con la tua email reale

  // =========================
  // STATO
  // =========================
  let currentLanguage = localStorage.getItem("matteoshare_lang") || "it";
  let filesData = [];
  let lastFilesSignature = null;
  let selectedFileIndex = null;
  let chatMessages = [];
  let chatPollingInterval = null;
  let filesPollingInterval = null;

  // =========================
  // I18N
  // =========================
  const i18n = {
    it: {
      brandSubtitle: "SOCIAL 3.0 ¬∑ SMART AUTO UPDATE",
      statusOnlineLabel: "Sistema online",
      tabFilesLabel: "File",
      tabNewsLabel: "News",
      tabSocialLabel: "Social 3.0",
      tabSettingsLabel: "Impostazioni",
      filesSubtitle: "Migliorare la grafica ¬∑ Sicurezza ¬∑ Auto update",
      filesBadgeLabel: "Foglio Google collegato",
      filesCountLabel: "File caricati:",
      thName: "Nome",
      thCategory: "Categoria",
      thSize: "Peso",
      thSecurity: "Sicurezza",
      syncStatusSyncing: "Sincronizzazione intelligente in corso‚Ä¶",
      syncStatusIdle: "Archivio aggiornato",
      syncStatusOffline: "Offline: uso cache locale",
      fileDetailPlaceholder: "Seleziona un file‚Ä¶",
      downloadBtnLabel: "Scarica file",
      openLinkBtnLabel: "Apri link diretto",
      reportBtnLabel: "Segnala file",
      newsTitle: "News & Aggiornamenti",
      newsSubtitle: "Aggiornamenti Social ¬∑ Sicurezza ¬∑ Funzioni",
      newsBadgeLabel: "News automatiche",
      newsItem1Title: "Social 3.0 attivo",
      newsItem1Meta: "Sistema di chat globale collegato a Google Sheets",
      newsItem1Body: "La chat globale ora scrive e legge direttamente dal tuo foglio Google, con aggiornamento automatico intelligente.",
      newsItem2Title: "Sistema di aggiornamento automatico ‚Äúintelligente‚Äù",
      newsItem2Meta: "Rilevamento cambiamenti sul foglio file",
      newsItem2Body: "L‚Äôarchivio file si aggiorna da solo quando rileva modifiche sul foglio, senza ricaricare l‚Äôintero sito.",
      socialTitle: "Social 3.0 ¬∑ Chat Globale",
      socialSubtitle: "Collegata a Google Sheets",
      socialBadgeLabel: "Chat globale attiva",
      chatStatusConnected: "Chat globale connessa",
      chatStatusError: "Errore chat globale",
      chatStatusSyncing: "Aggiornamento messaggi‚Ä¶",
      chatMessagesCountLabel: "Messaggi:",
      settingsTitle: "Impostazioni",
      settingsSubtitle: "Lingua ¬∑ Social 3.0 ¬∑ Sistema",
      settingsBadgeLabel: "Profilo locale",
      settingsLanguageLabel: "Lingua interfaccia",
      settingsLanguageNote: "La lingua cambia solo l‚Äôinterfaccia, non i contenuti dei file o della chat.",
      settingsSystemLabel: "Sistema",
      settingsSystemNote: "Il sistema controlla periodicamente il foglio Google per aggiornare file, news e chat senza ricaricare la pagina.",
      chipAutoUpdate: "Auto update intelligente",
      chipSocial: "Social 3.0",
      chipSecurity: "Monitor sicurezza"
    },
    en: {
      brandSubtitle: "SOCIAL 3.0 ¬∑ SMART AUTO UPDATE",
      statusOnlineLabel: "System online",
      tabFilesLabel: "Files",
      tabNewsLabel: "News",
      tabSocialLabel: "Social 3.0",
      tabSettingsLabel: "Settings",
      filesSubtitle: "Graphics ¬∑ Security ¬∑ Auto update",
      filesBadgeLabel: "Google Sheet connected",
      filesCountLabel: "Loaded files:",
      thName: "Name",
      thCategory: "Category",
      thSize: "Size",
      thSecurity: "Security",
      syncStatusSyncing: "Smart sync in progress‚Ä¶",
      syncStatusIdle: "Archive up to date",
      syncStatusOffline: "Offline: using local cache",
      fileDetailPlaceholder: "Select a file‚Ä¶",
      downloadBtnLabel: "Download file",
      openLinkBtnLabel: "Open direct link",
      reportBtnLabel: "Report file",
      newsTitle: "News & Updates",
      newsSubtitle: "Social updates ¬∑ Security ¬∑ Features",
      newsBadgeLabel: "Automatic news",
      newsItem1Title: "Social 3.0 enabled",
      newsItem1Meta: "Global chat system linked to Google Sheets",
      newsItem1Body: "Global chat now writes and reads directly from your Google Sheet, with smart auto update.",
      newsItem2Title: "‚ÄúSmart‚Äù auto update system",
      newsItem2Meta: "Change detection on files sheet",
      newsItem2Body: "The file archive updates itself when it detects changes on the sheet, without reloading the whole site.",
      socialTitle: "Social 3.0 ¬∑ Global Chat",
      socialSubtitle: "Linked to Google Sheets",
      socialBadgeLabel: "Global chat active",
      chatStatusConnected: "Global chat connected",
      chatStatusError: "Global chat error",
      chatStatusSyncing: "Updating messages‚Ä¶",
      chatMessagesCountLabel: "Messages:",
      settingsTitle: "Settings",
      settingsSubtitle: "Language ¬∑ Social 3.0 ¬∑ System",
      settingsBadgeLabel: "Local profile",
      settingsLanguageLabel: "Interface language",
      settingsLanguageNote: "Language changes only the interface, not file or chat contents.",
      settingsSystemLabel: "System",
      settingsSystemNote: "The system periodically checks the Google Sheet to update files, news and chat without reloading the page.",
      chipAutoUpdate: "Smart auto update",
      chipSocial: "Social 3.0",
      chipSecurity: "Security monitor"
    },
    ro: {
      brandSubtitle: "SOCIAL 3.0 ¬∑ ACTUALIZARE INTELIGENTƒÇ",
      statusOnlineLabel: "Sistem online",
      tabFilesLabel: "Fi»ôiere",
      tabNewsLabel: "»òtiri",
      tabSocialLabel: "Social 3.0",
      tabSettingsLabel: "SetƒÉri",
      filesSubtitle: "GraficƒÉ ¬∑ Securitate ¬∑ Auto update",
      filesBadgeLabel: "Google Sheet conectat",
      filesCountLabel: "Fi»ôiere √ÆncƒÉrcate:",
      thName: "Nume",
      thCategory: "Categorie",
      thSize: "Dimensiune",
      thSecurity: "Securitate",
      syncStatusSyncing: "Sincronizare inteligentƒÉ‚Ä¶",
      syncStatusIdle: "ArhivƒÉ actualizatƒÉ",
      syncStatusOffline: "Offline: folosesc cache local",
      fileDetailPlaceholder: "SelecteazƒÉ un fi»ôier‚Ä¶",
      downloadBtnLabel: "DescarcƒÉ fi»ôier",
      openLinkBtnLabel: "Deschide link direct",
      reportBtnLabel: "RaporteazƒÉ fi»ôier",
      newsTitle: "»òtiri & ActualizƒÉri",
      newsSubtitle: "Social ¬∑ Securitate ¬∑ Func»õii",
      newsBadgeLabel: "»òtiri automate",
      newsItem1Title: "Social 3.0 activ",
      newsItem1Meta: "Chat global legat de Google Sheets",
      newsItem1Body: "Chatul global scrie »ôi cite»ôte direct din Google Sheet, cu actualizare inteligentƒÉ.",
      newsItem2Title: "Sistem de auto update ‚Äûinteligent‚Äù",
      newsItem2Meta: "Detectare modificƒÉri √Æn foaia de fi»ôiere",
      newsItem2Body: "Arhiva de fi»ôiere se actualizeazƒÉ singurƒÉ c√¢nd detecteazƒÉ modificƒÉri √Æn foaie.",
      socialTitle: "Social 3.0 ¬∑ Chat Global",
      socialSubtitle: "Legat de Google Sheets",
      socialBadgeLabel: "Chat global activ",
      chatStatusConnected: "Chat global conectat",
      chatStatusError: "Eroare chat global",
      chatStatusSyncing: "Actualizare mesaje‚Ä¶",
      chatMessagesCountLabel: "Mesaje:",
      settingsTitle: "SetƒÉri",
      settingsSubtitle: "LimbƒÉ ¬∑ Social 3.0 ¬∑ Sistem",
      settingsBadgeLabel: "Profil local",
      settingsLanguageLabel: "Limba interfe»õei",
      settingsLanguageNote: "Limba schimbƒÉ doar interfa»õa, nu con»õinutul fi»ôierelor sau al chatului.",
      settingsSystemLabel: "Sistem",
      settingsSystemNote: "Sistemul verificƒÉ periodic foaia Google pentru a actualiza fi»ôierele, »ôtirile »ôi chatul fƒÉrƒÉ re√ÆncƒÉrcare.",
      chipAutoUpdate: "Auto update inteligent",
      chipSocial: "Social 3.0",
      chipSecurity: "Monitor securitate"
    },
    ru: {
      brandSubtitle: "SOCIAL 3.0 ¬∑ –£–ú–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï",
      statusOnlineLabel: "–°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω",
      tabFilesLabel: "–§–∞–π–ª—ã",
      tabNewsLabel: "–ù–æ–≤–æ—Å—Ç–∏",
      tabSocialLabel: "Social 3.0",
      tabSettingsLabel: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
      filesSubtitle: "–ì—Ä–∞—Ñ–∏–∫–∞ ¬∑ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ¬∑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
      filesBadgeLabel: "Google Sheet –ø–æ–¥–∫–ª—é—á–µ–Ω",
      filesCountLabel: "–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:",
      thName: "–ò–º—è",
      thCategory: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
      thSize: "–†–∞–∑–º–µ—Ä",
      thSecurity: "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
      syncStatusSyncing: "–£–º–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è‚Ä¶",
      syncStatusIdle: "–ê—Ä—Ö–∏–≤ –∞–∫—Ç—É–∞–ª–µ–Ω",
      syncStatusOffline: "–û—Ñ—Ñ–ª–∞–π–Ω: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à",
      fileDetailPlaceholder: "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª‚Ä¶",
      downloadBtnLabel: "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª",
      openLinkBtnLabel: "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É",
      reportBtnLabel: "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ñ–∞–π–ª",
      newsTitle: "–ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è",
      newsSubtitle: "Social ¬∑ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ¬∑ –§—É–Ω–∫—Ü–∏–∏",
      newsBadgeLabel: "–ê–≤—Ç–æ –Ω–æ–≤–æ—Å—Ç–∏",
      newsItem1Title: "Social 3.0 –∞–∫—Ç–∏–≤–µ–Ω",
      newsItem1Meta: "–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å Google Sheets",
      newsItem1Body: "–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç –ø–∏—à–µ—Ç –∏ —á–∏—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Google Sheets —Å —É–º–Ω—ã–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º.",
      newsItem2Title: "–°–∏—Å—Ç–µ–º–∞ ¬´—É–º–Ω–æ–≥–æ¬ª –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è",
      newsItem2Meta: "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª–∏—Å—Ç–µ —Ñ–∞–π–ª–æ–≤",
      newsItem2Body: "–ê—Ä—Ö–∏–≤ —Ñ–∞–π–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–∞–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –ª–∏—Å—Ç–µ, –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–∞–π—Ç–∞.",
      socialTitle: "Social 3.0 ¬∑ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç",
      socialSubtitle: "–°–≤—è–∑–∞–Ω —Å Google Sheets",
      socialBadgeLabel: "–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç –∞–∫—Ç–∏–≤–µ–Ω",
      chatStatusConnected: "–ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω",
      chatStatusError: "–û—à–∏–±–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞",
      chatStatusSyncing: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π‚Ä¶",
      chatMessagesCountLabel: "–°–æ–æ–±—â–µ–Ω–∏—è:",
      settingsTitle: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
      settingsSubtitle: "–Ø–∑—ã–∫ ¬∑ Social 3.0 ¬∑ –°–∏—Å—Ç–µ–º–∞",
      settingsBadgeLabel: "–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å",
      settingsLanguageLabel: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
      settingsLanguageNote: "–Ø–∑—ã–∫ –º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –Ω–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ —á–∞—Ç–∞.",
      settingsSystemLabel: "–°–∏—Å—Ç–µ–º–∞",
      settingsSystemNote: "–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Google Sheet, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã, –Ω–æ–≤–æ—Å—Ç–∏ –∏ —á–∞—Ç –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.",
      chipAutoUpdate: "–£–º–Ω–æ–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
      chipSocial: "Social 3.0",
      chipSecurity: "–ú–æ–Ω–∏—Ç–æ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
    }
  };

  function applyLanguage(lang) {
    const t = i18n[lang] || i18n.it;
    currentLanguage = lang;
    localStorage.setItem("matteoshare_lang", lang);

    document.getElementById("brandSubtitle").textContent = t.brandSubtitle;
    document.getElementById("statusOnlineLabel").textContent = t.statusOnlineLabel;
    document.getElementById("tabFilesLabel").textContent = t.tabFilesLabel;
    document.getElementById("tabNewsLabel").textContent = t.tabNewsLabel;
    document.getElementById("tabSocialLabel").textContent = t.tabSocialLabel;
    document.getElementById("tabSettingsLabel").textContent = t.tabSettingsLabel;
    document.getElementById("filesSubtitle").textContent = t.filesSubtitle;
    document.getElementById("filesBadgeLabel").textContent = t.filesBadgeLabel;
    document.getElementById("filesCountLabel").textContent = t.filesCountLabel;
    document.getElementById("thName").textContent = t.thName;
    document.getElementById("thCategory").textContent = t.thCategory;
    document.getElementById("thSize").textContent = t.thSize;
    document.getElementById("thSecurity").textContent = t.thSecurity;
    document.getElementById("syncStatusText").textContent = t.syncStatusIdle;
    document.getElementById("fileDetailName").textContent = t.fileDetailPlaceholder;
    document.getElementById("downloadBtnLabel").textContent = t.downloadBtnLabel;
    document.getElementById("openLinkBtnLabel").textContent = t.openLinkBtnLabel;
    document.getElementById("reportBtnLabel").textContent = t.reportBtnLabel;
    document.getElementById("newsTitle").textContent = t.newsTitle;
    document.getElementById("newsSubtitle").textContent = t.newsSubtitle;
    document.getElementById("newsBadgeLabel").textContent = t.newsBadgeLabel;
    document.getElementById("newsItem1Title").textContent = t.newsItem1Title;
    document.getElementById("newsItem1Meta").textContent = t.newsItem1Meta;
    document.getElementById("newsItem1Body").textContent = t.newsItem1Body;
    document.getElementById("newsItem2Title").textContent = t.newsItem2Title;
    document.getElementById("newsItem2Meta").textContent = t.newsItem2Meta;
    document.getElementById("newsItem2Body").textContent = t.newsItem2Body;
    document.getElementById("socialTitle").textContent = t.socialTitle;
    document.getElementById("socialSubtitle").textContent = t.socialSubtitle;
    document.getElementById("socialBadgeLabel").textContent = t.socialBadgeLabel;
    document.getElementById("chatStatusText").textContent = t.chatStatusConnected;
    document.getElementById("chatMessagesCountLabel").textContent = t.chatMessagesCountLabel;
    document.getElementById("settingsTitle").textContent = t.settingsTitle;
    document.getElementById("settingsSubtitle").textContent = t.settingsSubtitle;
    document.getElementById("settingsBadgeLabel").textContent = t.settingsBadgeLabel;
    document.getElementById("settingsLanguageLabel").textContent = t.settingsLanguageLabel;
    document.getElementById("settingsLanguageNote").textContent = t.settingsLanguageNote;
    document.getElementById("settingsSystemLabel").textContent = t.settingsSystemLabel;
    document.getElementById("settingsSystemNote").textContent = t.settingsSystemNote;
    document.getElementById("chipAutoUpdate").textContent = t.chipAutoUpdate;
    document.getElementById("chipSocial").textContent = t.chipSocial;
    document.getElementById("chipSecurity").textContent = t.chipSecurity;
  }

  // =========================
  // TABS
  // =========================
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.getAttribute("data-tab");
      document.querySelectorAll(".tab-panel").forEach(panel => {
        panel.classList.toggle("hidden", panel.getAttribute("data-tab-panel") !== tab);
      });
    });
  });

  // =========================
  // FILES: LETTURA GOOGLE SHEETS
  // =========================
  async function fetchFilesFromSheet() {
    if (!GOOGLE_SHEETS_FILES_URL || GOOGLE_SHEETS_FILES_URL.startsWith("INSERISCI_QUI")) {
      console.warn("Configura GOOGLE_SHEETS_FILES_URL nel codice.");
      return [];
    }
    try {
      document.getElementById("syncStatusDot").classList.remove("offline");
      document.getElementById("syncStatusDot").classList.add("syncing");
      document.getElementById("syncStatusText").textContent = i18n[currentLanguage].syncStatusSyncing;

      const res = await fetch(GOOGLE_SHEETS_FILES_URL);
      const text = await res.text();

      // Adatta qui al formato del tuo export (JSON, CSV, gviz, ecc.)
      // ESEMPIO per gviz:
      // const json = JSON.parse(text.substr(47).slice(0, -2));
      // const rows = json.table.rows;

      // Per semplicit√†, supponiamo JSON array con chiavi: nome,url,size,hash,categoria,note,sicurezza
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error("Impossibile fare parse JSON. Adatta il parser al formato del tuo foglio.", e);
        return filesData;
      }

      const mapped = data.map(row => ({
        nome: row.nome || row.Nome || "",
        url: row.url || row.URL || "",
        size: row.size || row.peso || "",
        hash: row.hash || "",
        categoria: row.categoria || "",
        note: row.note || "",
        sicurezza: row.sicurezza || ""
      }));

      return mapped;
    } catch (err) {
      console.error("Errore caricamento file:", err);
      document.getElementById("syncStatusDot").classList.remove("syncing");
      document.getElementById("syncStatusDot").classList.add("offline");
      document.getElementById("syncStatusText").textContent = i18n[currentLanguage].syncStatusOffline;
      return filesData;
    }
  }

  function signatureForFiles(files) {
    return JSON.stringify(files.map(f => ({
      nome: f.nome,
      url: f.url,
      size: f.size,
      hash: f.hash,
      categoria: f.categoria,
      sicurezza: f.sicurezza,
      note: f.note
    })));
  }

  function renderFilesTable() {
    const tbody = document.getElementById("filesTableBody");
    tbody.innerHTML = "";
    filesData.forEach((file, index) => {
      const tr = document.createElement("tr");
      tr.dataset.index = index;
      if (index === selectedFileIndex) tr.classList.add("selected");

      const tdName = document.createElement("td");
      tdName.textContent = file.nome || "(senza nome)";

      const tdCat = document.createElement("td");
      tdCat.textContent = file.categoria || "-";

      const tdSize = document.createElement("td");
      tdSize.textContent = file.size || "-";

      const tdSec = document.createElement("td");
      const tag = document.createElement("span");
      tag.className = "tag";
      const dot = document.createElement("span");
      dot.className = "tag-dot";
      const secText = (file.sicurezza || "").toLowerCase();
      if (secText.includes("sicuro") || secText.includes("safe")) {
        tag.classList.add("safe");
      } else if (secText.includes("attenzione") || secText.includes("warning")) {
        tag.classList.add("warn");
      } else if (secText.includes("pericoloso") || secText.includes("danger")) {
        tag.classList.add("danger");
      }
      const label = document.createElement("span");
      label.textContent = file.sicurezza || "-";
      tag.appendChild(dot);
      tag.appendChild(label);
      tdSec.appendChild(tag);

      tr.appendChild(tdName);
      tr.appendChild(tdCat);
      tr.appendChild(tdSize);
      tr.appendChild(tdSec);

      tr.addEventListener("click", () => {
        selectedFileIndex = index;
        document.querySelectorAll("#filesTableBody tr").forEach(r => r.classList.remove("selected"));
        tr.classList.add("selected");
        renderFileDetail(file);
      });

      tbody.appendChild(tr);
    });

    document.getElementById("filesCountValue").textContent = filesData.length.toString();
  }

  function renderFileDetail(file) {
    const t = i18n[currentLanguage];
    const detail = document.getElementById("fileDetail");
    detail.classList.add("visible");
    document.getElementById("fileDetailName").textContent = file.nome || t.fileDetailPlaceholder;
    document.getElementById("fileDetailCategory").textContent = file.categoria ? `Categoria: ${file.categoria}` : "";
    document.getElementById("fileDetailSize").textContent = file.size ? `Peso: ${file.size}` : "";
    document.getElementById("fileDetailHash").textContent = file.hash ? `Hash: ${file.hash}` : "";
    document.getElementById("fileDetailSecurity").textContent = file.sicurezza ? `Sicurezza: ${file.sicurezza}` : "";
    document.getElementById("fileDetailNotes").textContent = file.note || "";

    const downloadBtn = document.getElementById("fileDownloadBtn");
    const openBtn = document.getElementById("fileOpenUrlBtn");
    const reportBtn = document.getElementById("fileReportBtn");

    const url = file.url || "";
    downloadBtn.onclick = () => {
      if (!url) return;
      window.open(url, "_blank");
    };
    openBtn.onclick = () => {
      if (!url) return;
      window.open(url, "_blank");
    };
    reportBtn.onclick = () => {
      const subject = encodeURIComponent(`[MatteoShare] Segnalazione file: ${file.nome || ""}`);
      const body = encodeURIComponent(
        `Ciao,\n\nVorrei segnalare questo file:\n\n` +
        `Nome: ${file.nome || ""}\n` +
        `URL: ${file.url || ""}\n` +
        `Categoria: ${file.categoria || ""}\n` +
        `Peso: ${file.size || ""}\n` +
        `Sicurezza: ${file.sicurezza || ""}\n` +
        `Note: ${file.note || ""}\n\n` +
        `Motivo della segnalazione:\n[Scrivi qui]\n`
      );
      window.location.href = `mailto:${FILE_REPORT_EMAIL}?subject=${subject}&body=${body}`;
    };
  }

  async function smartFilesUpdate() {
    const newFiles = await fetchFilesFromSheet();
    if (!newFiles || !Array.isArray(newFiles)) return;

    const newSignature = signatureForFiles(newFiles);
    if (newSignature !== lastFilesSignature) {
      filesData = newFiles;
      lastFilesSignature = newSignature;
      renderFilesTable();
      document.getElementById("syncStatusDot").classList.remove("syncing", "offline");
      document.getElementById("syncStatusText").textContent = i18n[currentLanguage].syncStatusIdle;
      localStorage.setItem("matteoshare_files_cache", JSON.stringify(filesData));
      localStorage.setItem("matteoshare_files_signature", lastFilesSignature);
    } else {
      document.getElementById("syncStatusDot").classList.remove("syncing", "offline");
      document.getElementById("syncStatusText").textContent = i18n[currentLanguage].syncStatusIdle;
    }
  }

  function loadFilesFromCache() {
    try {
      const cache = localStorage.getItem("matteoshare_files_cache");
      const sig = localStorage.getItem("matteoshare_files_signature");
      if (cache && sig) {
        filesData = JSON.parse(cache);
        lastFilesSignature = sig;
        renderFilesTable();
      }
    } catch (e) {
      console.warn("Errore cache file:", e);
    }
  }

  // =========================
  // CHAT GLOBALE (Social 3.0)
  // =========================
  async function fetchChatMessages() {
    try {
      document.getElementById("chatStatusDot").classList.remove("offline");
      document.getElementById("chatStatusDot").classList.add("syncing");
      document.getElementById("chatStatusText").textContent = i18n[currentLanguage].chatStatusSyncing;

      const res = await fetch(GLOBAL_CHAT_ENDPOINT);
      const data = await res.json();
      chatMessages = Array.isArray(data) ? data : [];
      renderChatMessages();
      document.getElementById("chatStatusDot").classList.remove("syncing");
      document.getElementById("chatStatusDot").classList.remove("offline");
      document.getElementById("chatStatusText").textContent = i18n[currentLanguage].chatStatusConnected;
    } catch (err) {
      console.error("Errore chat globale:", err);
      document.getElementById("chatStatusDot").classList.add("offline");
      document.getElementById("chatStatusText").textContent = i18n[currentLanguage].chatStatusError;
    }
  }

  function renderChatMessages() {
    const container = document.getElementById("chatMessages");
    container.innerHTML = "";
    chatMessages.forEach(msg => {
      const div = document.createElement("div");
      div.className = "chat-message";

      const header = document.createElement("div");
      header.className = "chat-message-header";

      const userSpan = document.createElement("span");
      userSpan.className = "chat-message-user";
      userSpan.textContent = msg.user || "Anonimo";

      const timeSpan = document.createElement("span");
      const ts = msg.timestamp ? new Date(msg.timestamp) : null;
      timeSpan.textContent = ts && !isNaN(ts.getTime()) ? ts.toLocaleString() : "";

      header.appendChild(userSpan);
      header.appendChild(timeSpan);

      const body = document.createElement("div");
      body.textContent = msg.message || "";

      div.appendChild(header);
      div.appendChild(body);
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
    document.getElementById("chatMessagesCountValue").textContent = chatMessages.length.toString();
  }

  async function sendChatMessage() {
    const userInput = document.getElementById("chatUserInput");
    const msgInput = document.getElementById("chatMessageInput");
    const user = (userInput.value || "").trim() || "Anonimo";
    const message = (msgInput.value || "").trim();
    if (!message) return;

    try {
      document.getElementById("chatStatusDot").classList.add("syncing");
      document.getElementById("chatStatusText").textContent = i18n[currentLanguage].chatStatusSyncing;

      await fetch(GLOBAL_CHAT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user, message })
      });

      msgInput.value = "";
      await fetchChatMessages();
    } catch (err) {
      console.error("Errore invio messaggio:", err);
      document.getElementById("chatStatusDot").classList.add("offline");
      document.getElementById("chatStatusText").textContent = i18n[currentLanguage].chatStatusError;
    }
  }

  // =========================
  // INIT
  // =========================
  document.addEventListener("DOMContentLoaded", () => {
    // Lingua
    document.getElementById("languageSelect").value = currentLanguage;
    applyLanguage(currentLanguage);
    document.getElementById("languageSelect").addEventListener("change", e => {
      applyLanguage(e.target.value);
      // Risincronizza testi di stato
      document.getElementById("syncStatusText").textContent = i18n[currentLanguage].syncStatusIdle;
      document.getElementById("chatStatusText").textContent = i18n[currentLanguage].chatStatusConnected;
    });

    // Cache file
    loadFilesFromCache();
    smartFilesUpdate();
    filesPollingInterval = setInterval(smartFilesUpdate, 60000); // ogni 60s

    // Chat
    fetchChatMessages();
    chatPollingInterval = setInterval(fetchChatMessages, 5000); // ogni 5s

    document.getElementById("chatSendBtn").addEventListener("click", sendChatMessage);
    document.getElementById("chatMessageInput").addEventListener("keydown", e => {
      if (e.key === "Enter") sendChatMessage();
    });
  });
</script>
</body>
</html>
