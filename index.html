<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>MatteoShare · Social 3.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Verdana,Arial,Helvetica,sans-serif;
      background:#e5e5e5 url("https://rutracker.org/forum/styles/rutracker/theme/images/bg.gif") repeat;
      color:#000;
    }
    a{color:#004b91;text-decoration:none}
    a:hover{text-decoration:underline}
    .page{
      max-width:1180px;
      margin:10px auto 30px;
      background:#f5f5f5;
      border:1px solid #b0b0b0;
      box-shadow:0 0 4px rgba(0,0,0,0.2);
    }
    .header{
      background:#2f5b93 url("https://rutracker.org/forum/styles/rutracker/theme/images/bg_header.gif") repeat-x;
      color:#fff;
      padding:8px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .header-left{
      font-size:18px;
      font-weight:bold;
    }
    .header-right{
      font-size:11px;
      text-align:right;
    }
    .header-right span{
      display:block;
    }
    .nav-bar{
      background:#d6dde5;
      border-top:1px solid #b0b0b0;
      border-bottom:1px solid #b0b0b0;
      padding:4px 8px;
      font-size:11px;
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:4px;
    }
    .nav-links a{
      margin-right:8px;
      font-weight:bold;
    }
    .nav-status{
      font-size:11px;
      color:#333;
    }
    .nav-status span.label{font-weight:bold}
    .content{
      padding:8px;
    }
    .tabs{
      margin-bottom:8px;
      border-bottom:1px solid #b0b0b0;
      display:flex;
      flex-wrap:wrap;
      gap:2px;
    }
    .tab-btn{
      font-size:11px;
      padding:4px 10px;
      border:1px solid #b0b0b0;
      border-bottom:none;
      background:#d6dde5;
      cursor:pointer;
      border-radius:4px 4px 0 0;
    }
    .tab-btn.active{
      background:#ffffff;
      font-weight:bold;
      border-bottom:1px solid #ffffff;
    }
    .tab-panel{display:none}
    .tab-panel.active{display:block}
    .two-cols{
      display:grid;
      grid-template-columns:2.1fr 1.4fr;
      gap:8px;
    }
    @media(max-width:900px){
      .two-cols{grid-template-columns:1fr}
    }
    .block{
      border:1px solid #b0b0b0;
      background:#ffffff;
      margin-bottom:8px;
    }
    .block-header{
      background:#d6dde5;
      padding:4px 6px;
      font-size:11px;
      font-weight:bold;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .block-header small{font-weight:normal;color:#555}
    .block-body{
      padding:6px;
      font-size:11px;
    }
    .block-footer{
      padding:4px 6px;
      font-size:10px;
      background:#f0f0f0;
      border-top:1px solid #d0d0d0;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .status-led{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      margin-right:4px;
      background:#0a0;
    }
    .status-led.offline{background:#a00}
    .status-led.sync{background:#cc0}
    table.forum-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .forum-table th,
    .forum-table td{
      border:1px solid #d0d0d0;
      padding:3px 4px;
      vertical-align:middle;
    }
    .forum-table th{
      background:#d6dde5;
      color:#000;
      text-align:left;
      white-space:nowrap;
    }
    .forum-table tr:nth-child(even){
      background:#f7f7f7;
    }
    .forum-table tr:hover{
      background:#e3f1ff;
    }
    .forum-table tr.selected{
      background:#c7e1ff;
    }
    .tag{
      display:inline-block;
      padding:1px 4px;
      border-radius:3px;
      border:1px solid #b0b0b0;
      background:#f0f0f0;
      font-size:10px;
    }
    .tag.safe{background:#dfffdc;border-color:#9acb8a}
    .tag.warn{background:#fff6d6;border-color:#d8b45a}
    .tag.danger{background:#ffe0e0;border-color:#d88a8a}
    .file-detail{
      margin-top:6px;
      border-top:1px dashed #d0d0d0;
      padding-top:6px;
      display:none;
    }
    .file-detail.visible{display:block}
    .file-detail-title{
      font-size:12px;
      font-weight:bold;
      margin-bottom:4px;
    }
    .file-meta span{
      display:inline-block;
      margin-right:10px;
      margin-bottom:2px;
    }
    .file-notes{
      margin-top:4px;
      font-size:11px;
    }
    .btn{
      font-size:11px;
      padding:2px 8px;
      border:1px solid #b0b0b0;
      background:#e5e5e5;
      cursor:pointer;
      border-radius:3px;
      margin-right:4px;
      margin-top:2px;
    }
    .btn:hover{
      background:#d6dde5;
    }
    .btn-danger{
      background:#ffe0e0;
      border-color:#d88a8a;
    }
    .btn-danger:hover{
      background:#ffd0d0;
    }
    .news-item{
      border-bottom:1px solid #e0e0e0;
      padding:4px 0;
    }
    .news-title{
      font-weight:bold;
      margin-bottom:2px;
    }
    .news-meta{
      font-size:10px;
      color:#777;
      margin-bottom:2px;
    }
    .news-body{
      font-size:11px;
    }
    .chat-box{
      border:1px solid #d0d0d0;
      background:#ffffff;
      display:flex;
      flex-direction:column;
      height:260px;
    }
    .chat-messages{
      flex:1;
      padding:4px;
      overflow-y:auto;
      font-size:11px;
      background:#ffffff;
    }
    .chat-message{
      border-bottom:1px solid #f0f0f0;
      padding:2px 0;
    }
    .chat-header{
      display:flex;
      justify-content:space-between;
      font-size:10px;
      color:#777;
    }
    .chat-user{font-weight:bold}
    .chat-input{
      border-top:1px solid #d0d0d0;
      padding:4px;
      background:#f5f5f5;
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }
    .input,select{
      font-size:11px;
      padding:2px 4px;
      border:1px solid #b0b0b0;
      background:#ffffff;
      border-radius:3px;
    }
    .input-small{max-width:120px}
    .settings-grid{
      display:grid;
      grid-template-columns:1.2fr 1.2fr;
      gap:8px;
    }
    @media(max-width:800px){
      .settings-grid{grid-template-columns:1fr}
    }
    .settings-block{
      border:1px solid #d0d0d0;
      background:#ffffff;
      padding:6px;
      font-size:11px;
    }
    .settings-title{
      font-weight:bold;
      margin-bottom:4px;
    }
    .settings-note{
      font-size:10px;
      color:#666;
      margin-top:4px;
    }
    .chip{
      display:inline-block;
      padding:1px 6px;
      border-radius:10px;
      border:1px solid #b0b0b0;
      background:#f0f0f0;
      font-size:10px;
      margin-right:4px;
      margin-top:2px;
    }
    .hidden{display:none!important}
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .login-box{
      width:360px;
      background:#f5f5f5;
      border:1px solid #b0b0b0;
      box-shadow:0 0 6px rgba(0,0,0,0.4);
    }
    .login-header{
      background:#2f5b93;
      color:#fff;
      padding:6px 8px;
      font-size:12px;
      font-weight:bold;
    }
    .login-body{
      padding:8px;
      font-size:11px;
    }
    .login-body label{
      display:block;
      margin-top:4px;
      margin-bottom:2px;
    }
    .login-actions{
      margin-top:8px;
      text-align:right;
    }
    .login-error{
      color:#a00;
      font-size:10px;
      margin-top:4px;
      display:none;
    }
    .footer{
      padding:6px 8px;
      font-size:10px;
      color:#666;
      border-top:1px solid #d0d0d0;
      background:#f0f0f0;
      text-align:right;
    }
  </style>
</head>
<body>
<div class="page">

  <!-- LOGIN / REGISTRAZIONE LOCALE -->
  <div class="overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-header">MatteoShare · Accesso account locale</div>
      <div class="login-body">
        <div style="margin-bottom:6px;">
          Benvenuto in <b>MatteoShare · Social 3.0</b>.<br>
          Crea o accedi a un <b>account locale</b> per usare il sito e la chat globale.
        </div>
        <label for="loginMode">Modalità</label>
        <select id="loginMode" class="input" style="width:100%;">
          <option value="login">Login (account esistente)</option>
          <option value="create">Crea nuovo account</option>
        </select>
        <label for="loginUsername">Nome utente</label>
        <input id="loginUsername" class="input" type="text" style="width:100%;" placeholder="Es. Matteo">
        <label for="loginPassword">Password</label>
        <input id="loginPassword" class="input" type="password" style="width:100%;" placeholder="Password">
        <div class="login-error" id="loginError"></div>
        <div class="login-actions">
          <button class="btn" id="loginConfirmBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      MatteoShare · Social 3.0
    </div>
    <div class="header-right">
      <span>Archivio file · Chat globale · News</span>
      <span>Interfaccia stile forum (tipo rutracker)</span>
    </div>
  </div>

  <!-- NAV BAR -->
  <div class="nav-bar">
    <div class="nav-links">
      <a href="javascript:void(0)">Indice</a>
      <a href="javascript:void(0)">File</a>
      <a href="javascript:void(0)">Social 3.0</a>
      <a href="javascript:void(0)">Impostazioni</a>
      <a href="javascript:void(0)">Aiuto</a>
    </div>
    <div class="nav-status">
      <span class="label">Utente:</span> <span id="accountNameLabel">-</span> ·
      <span class="label">Stato:</span> <span id="globalStatusText">Sistema online · Account locale non configurato</span>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="files">File</button>
      <button class="tab-btn" data-tab="news">News</button>
      <button class="tab-btn" data-tab="social">Social 3.0</button>
      <button class="tab-btn" data-tab="settings">Impostazioni</button>
    </div>

    <!-- PANELS -->
    <div class="tab-panel active" data-tab-panel="files">
      <div class="two-cols">
        <div>
          <div class="block">
            <div class="block-header">
              <span id="filesTitle">Archivio file collegato a Google Sheets</span>
              <small id="filesBadge">Foglio: nome, url, size, hash, categoria, note, sicurezza</small>
            </div>
            <div class="block-body">
              <table class="forum-table" id="filesTable">
                <thead>
                <tr>
                  <th id="thName">Nome</th>
                  <th id="thCategory">Categoria</th>
                  <th id="thSize">Peso</th>
                  <th id="thSecurity">Sicurezza</th>
                </tr>
                </thead>
                <tbody id="filesTableBody"></tbody>
              </table>

              <div class="file-detail" id="fileDetail">
                <div class="file-detail-title" id="fileDetailName">Seleziona un file…</div>
                <div class="file-meta">
                  <span id="fileDetailCategory"></span>
                  <span id="fileDetailSize"></span>
                  <span id="fileDetailHash"></span>
                  <span id="fileDetailSecurity"></span>
                </div>
                <div class="file-notes" id="fileDetailNotes"></div>
                <div style="margin-top:4px;">
                  <button class="btn" id="fileDownloadBtn">Scarica file</button>
                  <button class="btn" id="fileOpenUrlBtn">Apri link diretto</button>
                  <button class="btn btn-danger" id="fileReportBtn">Segnala file</button>
                </div>
              </div>
            </div>
            <div class="block-footer">
              <div>
                <span class="status-led sync" id="filesStatusLed"></span>
                <span id="filesStatusText">Sincronizzazione intelligente in corso…</span>
              </div>
              <div>File: <span id="filesCountValue">0</span></div>
            </div>
          </div>
        </div>

        <div>
          <div class="block">
            <div class="block-header">
              <span id="newsTitle">News & aggiornamenti</span>
              <small id="newsBadge">Social 3.0 · Sicurezza · Funzioni</small>
            </div>
            <div class="block-body" id="newsList">
              <div class="news-item">
                <div class="news-title" id="newsItem1Title">Social 3.0 attivo</div>
                <div class="news-meta" id="newsItem1Meta">Chat globale collegata a Google Sheets</div>
                <div class="news-body" id="newsItem1Body">
                  La chat globale scrive e legge direttamente dal tuo foglio Google, con aggiornamento automatico.
                </div>
              </div>
              <div class="news-item">
                <div class="news-title" id="newsItem2Title">Sistema di auto update intelligente</div>
                <div class="news-meta" id="newsItem2Meta">Rilevamento modifiche sul foglio file</div>
                <div class="news-body" id="newsItem2Body">
                  L’archivio file si aggiorna quando rileva cambiamenti sul foglio, senza ricaricare il sito.
                </div>
              </div>
            </div>
            <div class="block-footer">
              <div>
                <span class="status-led" id="newsStatusLed"></span>
                <span id="newsStatusText">News statiche · Foglio news opzionale</span>
              </div>
              <div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-panel" data-tab-panel="news">
      <div class="block">
        <div class="block-header">
          <span id="newsTitle2">News & aggiornamenti</span>
          <small id="newsBadge2">Social 3.0 · Sicurezza · Funzioni</small>
        </div>
        <div class="block-body" id="newsList2">
          <!-- Riutilizzo le stesse news -->
          <div class="news-item">
            <div class="news-title" id="news2Item1Title">Social 3.0 attivo</div>
            <div class="news-meta" id="news2Item1Meta">Chat globale collegata a Google Sheets</div>
            <div class="news-body" id="news2Item1Body">
              La chat globale scrive e legge direttamente dal tuo foglio Google, con aggiornamento automatico.
            </div>
          </div>
          <div class="news-item">
            <div class="news-title" id="news2Item2Title">Sistema di auto update intelligente</div>
            <div class="news-meta" id="news2Item2Meta">Rilevamento modifiche sul foglio file</div>
            <div class="news-body" id="news2Item2Body">
              L’archivio file si aggiorna quando rileva cambiamenti sul foglio, senza ricaricare il sito.
            </div>
          </div>
        </div>
        <div class="block-footer">
          <div>
            <span class="status-led" id="newsStatusLed2"></span>
            <span id="newsStatusText2">News statiche · Foglio news opzionale</span>
          </div>
          <div></div>
        </div>
      </div>
    </div>

    <div class="tab-panel" data-tab-panel="social">
      <div class="two-cols">
        <div>
          <div class="block">
            <div class="block-header">
              <span id="socialTitle">Social 3.0 · Chat globale</span>
              <small id="socialBadge">Collegata a Google Sheets</small>
            </div>
            <div class="block-body">
              <div class="chat-box">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                  <input id="chatUserInput" class="input input-small" placeholder="Nome utente">
                  <input id="chatMessageInput" class="input" style="flex:1;" placeholder="Scrivi un messaggio globale…">
                  <button class="btn" id="chatSendBtn">Invia</button>
                </div>
              </div>
            </div>
            <div class="block-footer">
              <div>
                <span class="status-led" id="chatStatusLed"></span>
                <span id="chatStatusText">Chat globale connessa</span>
              </div>
              <div>Messaggi: <span id="chatMessagesCountValue">0</span></div>
            </div>
          </div>
        </div>
        <div>
          <div class="block">
            <div class="block-header">
              <span>Info Social 3.0</span>
              <small>Chat globale + account locale</small>
            </div>
            <div class="block-body">
              <p>
                La chat globale è collegata al tuo Google Sheets tramite Google Apps Script.<br>
                Ogni messaggio viene salvato nel foglio e letto da tutti gli utenti collegati.
              </p>
              <p style="margin-top:4px;">
                Il nome visualizzato nella chat usa il tuo <b>account locale</b> (username).
              </p>
              <p style="margin-top:4px;">
                L’aggiornamento è automatico ogni pochi secondi, in stile “chat globale” condivisa.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-panel" data-tab-panel="settings">
      <div class="block">
        <div class="block-header">
          <span id="settingsTitle">Impostazioni</span>
          <small id="settingsBadge">Lingua · Social 3.0 · Sistema</small>
        </div>
        <div class="block-body">
          <div class="settings-grid">
            <div class="settings-block">
              <div class="settings-title" id="settingsLanguageLabel">Lingua interfaccia</div>
              <select id="languageSelect" class="input" style="width:100%;">
                <option value="it">Italiano (predefinito)</option>
                <option value="en">English</option>
                <option value="ro">Română</option>
                <option value="ru">Русский</option>
              </select>
              <div class="settings-note" id="settingsLanguageNote">
                La lingua cambia solo l’interfaccia, non i contenuti dei file o della chat.
              </div>
            </div>
            <div class="settings-block">
              <div class="settings-title" id="settingsSystemLabel">Sistema</div>
              <div>
                <span class="chip" id="chipAutoUpdate">Auto update intelligente</span>
                <span class="chip" id="chipSocial">Social 3.0</span>
                <span class="chip" id="chipSecurity">Monitor sicurezza</span>
              </div>
              <div class="settings-note" id="settingsSystemNote">
                Il sistema controlla periodicamente i fogli Google per aggiornare file, news e chat senza ricaricare la pagina.
              </div>
            </div>
          </div>
          <div class="settings-block" style="margin-top:8px;">
            <div class="settings-title">Account locale</div>
            <div class="settings-note">
              Utente corrente: <b><span id="settingsAccountName">-</span></b><br>
              <button class="btn" id="changeAccountBtn" style="margin-top:4px;">Cambia / reimposta account locale</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="footer">
    MatteoShare · Social 3.0 · Interfaccia stile forum · Powered by Google Sheets + Google Apps Script
  </div>
</div>

<script>
  // CONFIG
  const GOOGLE_SHEETS_FILES_URL = ""; // opzionale: URL export del foglio file (JSON/CSV/gviz) da adattare nel parser
  const GLOBAL_CHAT_ENDPOINT = "https://script.google.com/macros/s/AKfycbxMfTpIoNC6VVsFNO5JjX8SX0vwVFz2wLrTFRxcNlO6Kk8kA-hOZiJ1V3j0NJFKt_3F1A/exec";
  const FILE_REPORT_EMAIL = "report@matteoshare.local";

  let currentLanguage = localStorage.getItem("matteoshare_lang") || "it";
  let filesData = [];
  let lastFilesSignature = null;
  let selectedFileIndex = null;
  let chatMessages = [];
  let chatPollingInterval = null;
  let filesPollingInterval = null;
  let localAccount = null;

  const i18n = {
    it:{
      globalStatusNoAccount:"Sistema online · Account locale non configurato",
      globalStatusWithAccount:"Sistema online · Account locale attivo",
      filesTitle:"Archivio file collegato a Google Sheets",
      filesBadge:"Foglio: nome, url, size, hash, categoria, note, sicurezza",
      thName:"Nome",
      thCategory:"Categoria",
      thSize:"Peso",
      thSecurity:"Sicurezza",
      filesSyncing:"Sincronizzazione intelligente in corso…",
      filesIdle:"Archivio aggiornato",
      filesOffline:"Offline: uso cache locale",
      fileDetailPlaceholder:"Seleziona un file…",
      downloadBtn:"Scarica file",
      openBtn:"Apri link diretto",
      reportBtn:"Segnala file",
      newsTitle:"News & aggiornamenti",
      newsBadge:"Social 3.0 · Sicurezza · Funzioni",
      newsItem1Title:"Social 3.0 attivo",
      newsItem1Meta:"Chat globale collegata a Google Sheets",
      newsItem1Body:"La chat globale scrive e legge direttamente dal tuo foglio Google, con aggiornamento automatico.",
      newsItem2Title:"Sistema di auto update intelligente",
      newsItem2Meta:"Rilevamento modifiche sul foglio file",
      newsItem2Body:"L’archivio file si aggiorna quando rileva cambiamenti sul foglio, senza ricaricare il sito.",
      socialTitle:"Social 3.0 · Chat globale",
      socialBadge:"Collegata a Google Sheets",
      chatConnected:"Chat globale connessa",
      chatError:"Errore chat globale",
      chatSyncing:"Aggiornamento messaggi…",
      settingsTitle:"Impostazioni",
      settingsBadge:"Lingua · Social 3.0 · Sistema",
      settingsLanguageLabel:"Lingua interfaccia",
      settingsLanguageNote:"La lingua cambia solo l’interfaccia, non i contenuti dei file o della chat.",
      settingsSystemLabel:"Sistema",
      settingsSystemNote:"Il sistema controlla periodicamente i fogli Google per aggiornare file, news e chat senza ricaricare la pagina.",
      chipAutoUpdate:"Auto update intelligente",
      chipSocial:"Social 3.0",
      chipSecurity:"Monitor sicurezza"
    },
    en:{
      globalStatusNoAccount:"System online · Local account not configured",
      globalStatusWithAccount:"System online · Local account active",
      filesTitle:"File archive linked to Google Sheets",
      filesBadge:"Sheet: name, url, size, hash, category, note, security",
      thName:"Name",
      thCategory:"Category",
      thSize:"Size",
      thSecurity:"Security",
      filesSyncing:"Smart sync in progress…",
      filesIdle:"Archive up to date",
      filesOffline:"Offline: using local cache",
      fileDetailPlaceholder:"Select a file…",
      downloadBtn:"Download file",
      openBtn:"Open direct link",
      reportBtn:"Report file",
      newsTitle:"News & updates",
      newsBadge:"Social 3.0 · Security · Features",
      newsItem1Title:"Social 3.0 enabled",
      newsItem1Meta:"Global chat linked to Google Sheets",
      newsItem1Body:"Global chat writes and reads directly from your Google Sheet, with automatic updates.",
      newsItem2Title:"Smart auto update system",
      newsItem2Meta:"Change detection on files sheet",
      newsItem2Body:"The file archive updates when it detects changes on the sheet, without reloading the site.",
      socialTitle:"Social 3.0 · Global chat",
      socialBadge:"Linked to Google Sheets",
      chatConnected:"Global chat connected",
      chatError:"Global chat error",
      chatSyncing:"Updating messages…",
      settingsTitle:"Settings",
      settingsBadge:"Language · Social 3.0 · System",
      settingsLanguageLabel:"Interface language",
      settingsLanguageNote:"Language changes only the interface, not file or chat contents.",
      settingsSystemLabel:"System",
      settingsSystemNote:"The system periodically checks the sheets to update files, news and chat without reloading.",
      chipAutoUpdate:"Smart auto update",
      chipSocial:"Social 3.0",
      chipSecurity:"Security monitor"
    },
    ro:{
      globalStatusNoAccount:"Sistem online · Cont local neconfigurat",
      globalStatusWithAccount:"Sistem online · Cont local activ",
      filesTitle:"Arhivă fișiere legată de Google Sheets",
      filesBadge:"Foaie: nume, url, size, hash, categorie, note, securitate",
      thName:"Nume",
      thCategory:"Categorie",
      thSize:"Dimensiune",
      thSecurity:"Securitate",
      filesSyncing:"Sincronizare inteligentă…",
      filesIdle:"Arhivă actualizată",
      filesOffline:"Offline: folosesc cache local",
      fileDetailPlaceholder:"Selectează un fișier…",
      downloadBtn:"Descarcă fișier",
      openBtn:"Deschide link direct",
      reportBtn:"Raportează fișier",
      newsTitle:"Știri & actualizări",
      newsBadge:"Social 3.0 · Securitate · Funcții",
      newsItem1Title:"Social 3.0 activ",
      newsItem1Meta:"Chat global legat de Google Sheets",
      newsItem1Body:"Chatul global scrie și citește direct din Google Sheet, cu actualizare automată.",
      newsItem2Title:"Sistem de auto update inteligent",
      newsItem2Meta:"Detectare modificări în foaia de fișiere",
      newsItem2Body:"Arhiva de fișiere se actualizează când detectează modificări în foaie.",
      socialTitle:"Social 3.0 · Chat global",
      socialBadge:"Legat de Google Sheets",
      chatConnected:"Chat global conectat",
      chatError:"Eroare chat global",
      chatSyncing:"Actualizare mesaje…",
      settingsTitle:"Setări",
      settingsBadge:"Limbă · Social 3.0 · Sistem",
      settingsLanguageLabel:"Limba interfeței",
      settingsLanguageNote:"Limba schimbă doar interfața, nu conținutul fișierelor sau al chatului.",
      settingsSystemLabel:"Sistem",
      settingsSystemNote:"Sistemul verifică periodic foile pentru a actualiza fișierele, știrile și chatul fără reîncărcare.",
      chipAutoUpdate:"Auto update inteligent",
      chipSocial:"Social 3.0",
      chipSecurity:"Monitor securitate"
    },
    ru:{
      globalStatusNoAccount:"Система онлайн · Локальный аккаунт не настроен",
      globalStatusWithAccount:"Система онлайн · Локальный аккаунт активен",
      filesTitle:"Архив файлов, связанный с Google Sheets",
      filesBadge:"Лист: name, url, size, hash, category, note, security",
      thName:"Имя",
      thCategory:"Категория",
      thSize:"Размер",
      thSecurity:"Безопасность",
      filesSyncing:"Умная синхронизация…",
      filesIdle:"Архив актуален",
      filesOffline:"Оффлайн: используется локальный кэш",
      fileDetailPlaceholder:"Выберите файл…",
      downloadBtn:"Скачать файл",
      openBtn:"Открыть прямую ссылку",
      reportBtn:"Пожаловаться на файл",
      newsTitle:"Новости и обновления",
      newsBadge:"Social 3.0 · Безопасность · Функции",
      newsItem1Title:"Social 3.0 активен",
      newsItem1Meta:"Глобальный чат, связанный с Google Sheets",
      newsItem1Body:"Глобальный чат пишет и читает напрямую из Google Sheets с автообновлением.",
      newsItem2Title:"Система умного автообновления",
      newsItem2Meta:"Отслеживание изменений в листе файлов",
      newsItem2Body:"Архив файлов обновляется при изменениях в листе, без перезагрузки сайта.",
      socialTitle:"Social 3.0 · Глобальный чат",
      socialBadge:"Связан с Google Sheets",
      chatConnected:"Глобальный чат подключен",
      chatError:"Ошибка глобального чата",
      chatSyncing:"Обновление сообщений…",
      settingsTitle:"Настройки",
      settingsBadge:"Язык · Social 3.0 · Система",
      settingsLanguageLabel:"Язык интерфейса",
      settingsLanguageNote:"Язык меняет только интерфейс, не содержимое файлов или чата.",
      settingsSystemLabel:"Система",
      settingsSystemNote:"Система периодически проверяет листы, чтобы обновлять файлы, новости и чат без перезагрузки.",
      chipAutoUpdate:"Умное автообновление",
      chipSocial:"Social 3.0",
      chipSecurity:"Монитор безопасности"
    }
  };

  function applyLanguage(lang){
    const t=i18n[lang]||i18n.it;
    currentLanguage=lang;
    localStorage.setItem("matteoshare_lang",lang);

    document.getElementById("filesTitle").textContent=t.filesTitle;
    document.getElementById("filesBadge").textContent=t.filesBadge;
    document.getElementById("thName").textContent=t.thName;
    document.getElementById("thCategory").textContent=t.thCategory;
    document.getElementById("thSize").textContent=t.thSize;
    document.getElementById("thSecurity").textContent=t.thSecurity;
    document.getElementById("filesStatusText").textContent=t.filesIdle;
    document.getElementById("fileDetailName").textContent=t.fileDetailPlaceholder;
    document.getElementById("fileDownloadBtn").textContent=t.downloadBtn;
    document.getElementById("fileOpenUrlBtn").textContent=t.openBtn;
    document.getElementById("fileReportBtn").textContent=t.reportBtn;

    document.getElementById("newsTitle").textContent=t.newsTitle;
    document.getElementById("newsBadge").textContent=t.newsBadge;
    document.getElementById("newsItem1Title").textContent=t.newsItem1Title;
    document.getElementById("newsItem1Meta").textContent=t.newsItem1Meta;
    document.getElementById("newsItem1Body").textContent=t.newsItem1Body;
    document.getElementById("newsItem2Title").textContent=t.newsItem2Title;
    document.getElementById("newsItem2Meta").textContent=t.newsItem2Meta;
    document.getElementById("newsItem2Body").textContent=t.newsItem2Body;

    document.getElementById("newsTitle2").textContent=t.newsTitle;
    document.getElementById("newsBadge2").textContent=t.newsBadge;
    document.getElementById("news2Item1Title").textContent=t.newsItem1Title;
    document.getElementById("news2Item1Meta").textContent=t.newsItem1Meta;
    document.getElementById("news2Item1Body").textContent=t.newsItem1Body;
    document.getElementById("news2Item2Title").textContent=t.newsItem2Title;
    document.getElementById("news2Item2Meta").textContent=t.newsItem2Meta;
    document.getElementById("news2Item2Body").textContent=t.newsItem2Body;

    document.getElementById("socialTitle").textContent=t.socialTitle;
    document.getElementById("socialBadge").textContent=t.socialBadge;
    document.getElementById("chatStatusText").textContent=t.chatConnected;

    document.getElementById("settingsTitle").textContent=t.settingsTitle;
    document.getElementById("settingsBadge").textContent=t.settingsBadge;
    document.getElementById("settingsLanguageLabel").textContent=t.settingsLanguageLabel;
    document.getElementById("settingsLanguageNote").textContent=t.settingsLanguageNote;
    document.getElementById("settingsSystemLabel").textContent=t.settingsSystemLabel;
    document.getElementById("settingsSystemNote").textContent=t.settingsSystemNote;
    document.getElementById("chipAutoUpdate").textContent=t.chipAutoUpdate;
    document.getElementById("chipSocial").textContent=t.chipSocial;
    document.getElementById("chipSecurity").textContent=t.chipSecurity;

    updateGlobalStatus();
  }

  function loadLocalAccount(){
    const raw=localStorage.getItem("matteoshare_account");
    if(!raw)return null;
    try{return JSON.parse(raw);}catch(e){return null;}
  }
  function saveLocalAccount(acc){
    localAccount=acc;
    localStorage.setItem("matteoshare_account",JSON.stringify(acc));
    document.getElementById("accountNameLabel").textContent=acc.username;
    document.getElementById("settingsAccountName").textContent=acc.username;
    const chatUserInput=document.getElementById("chatUserInput");
    if(chatUserInput && !chatUserInput.value) chatUserInput.value=acc.username;
    updateGlobalStatus();
  }
  function updateGlobalStatus(){
    const t=i18n[currentLanguage]||i18n.it;
    const label=document.getElementById("globalStatusText");
    if(localAccount){
      label.textContent=t.globalStatusWithAccount;
    }else{
      label.textContent=t.globalStatusNoAccount;
    }
  }
  function showLoginOverlay(){
    document.getElementById("loginOverlay").classList.remove("hidden");
  }
  function hideLoginOverlay(){
    document.getElementById("loginOverlay").classList.add("hidden");
  }

  async function hashPassword(password){
    const enc=new TextEncoder().encode(password);
    const buf=await crypto.subtle.digest("SHA-256",enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab=btn.getAttribute("data-tab");
      document.querySelectorAll(".tab-panel").forEach(p=>{
        p.classList.toggle("active",p.getAttribute("data-tab-panel")===tab);
      });
    });
  });

  function signatureForFiles(files){
    return JSON.stringify(files.map(f=>({
      nome:f.nome,url:f.url,size:f.size,hash:f.hash,categoria:f.categoria,sicurezza:f.sicurezza,note:f.note
    })));
  }
  function renderFilesTable(){
    const tbody=document.getElementById("filesTableBody");
    tbody.innerHTML="";
    filesData.forEach((file,index)=>{
      const tr=document.createElement("tr");
      tr.dataset.index=index;
      if(index===selectedFileIndex) tr.classList.add("selected");
      const tdName=document.createElement("td");
      tdName.textContent=file.nome||"(senza nome)";
      const tdCat=document.createElement("td");
      tdCat.textContent=file.categoria||"-";
      const tdSize=document.createElement("td");
      tdSize.textContent=file.size||"-";
      const tdSec=document.createElement("td");
      const tag=document.createElement("span");
      tag.className="tag";
      const sec=(file.sicurezza||"").toLowerCase();
      if(sec.includes("sicuro")||sec.includes("safe")) tag.classList.add("safe");
      else if(sec.includes("attenzione")||sec.includes("warn")) tag.classList.add("warn");
      else if(sec.includes("pericoloso")||sec.includes("danger")) tag.classList.add("danger");
      tag.textContent=file.sicurezza||"-";
      tdSec.appendChild(tag);
      tr.appendChild(tdName);
      tr.appendChild(tdCat);
      tr.appendChild(tdSize);
      tr.appendChild(tdSec);
      tr.addEventListener("click",()=>{
        selectedFileIndex=index;
        document.querySelectorAll("#filesTableBody tr").forEach(r=>r.classList.remove("selected"));
        tr.classList.add("selected");
        renderFileDetail(file);
      });
      tbody.appendChild(tr);
    });
    document.getElementById("filesCountValue").textContent=filesData.length.toString();
  }
  function renderFileDetail(file){
    const t=i18n[currentLanguage]||i18n.it;
    const detail=document.getElementById("fileDetail");
    detail.classList.add("visible");
    document.getElementById("fileDetailName").textContent=file.nome||t.fileDetailPlaceholder;
    document.getElementById("fileDetailCategory").textContent=file.categoria?("Categoria: "+file.categoria):"";
    document.getElementById("fileDetailSize").textContent=file.size?("Peso: "+file.size):"";
    document.getElementById("fileDetailHash").textContent=file.hash?("Hash: "+file.hash):"";
    document.getElementById("fileDetailSecurity").textContent=file.sicurezza?("Sicurezza: "+file.sicurezza):"";
    document.getElementById("fileDetailNotes").textContent=file.note||"";
    const url=file.url||"";
    document.getElementById("fileDownloadBtn").onclick=()=>{if(url)window.open(url,"_blank");};
    document.getElementById("fileOpenUrlBtn").onclick=()=>{if(url)window.open(url,"_blank");};
    document.getElementById("fileReportBtn").onclick=()=>{
      const subject=encodeURIComponent("[MatteoShare] Segnalazione file: "+(file.nome||""));
      const body=encodeURIComponent(
        "Ciao,\n\nVorrei segnalare questo file:\n\n"+
        "Nome: "+(file.nome||"")+"\n"+
        "URL: "+(file.url||"")+"\n"+
        "Categoria: "+(file.categoria||"")+"\n"+
        "Peso: "+(file.size||"")+"\n"+
        "Sicurezza: "+(file.sicurezza||"")+"\n"+
        "Note: "+(file.note||"")+"\n\n"+
        "Motivo della segnalazione:\n[Scrivi qui]\n"
      );
      window.location.href=`mailto:${FILE_REPORT_EMAIL}?subject=${subject}&body=${body}`;
    };
  }
  function loadFilesFromCache(){
    try{
      const cache=localStorage.getItem("matteoshare_files_cache");
      const sig=localStorage.getItem("matteoshare_files_signature");
      if(cache && sig){
        filesData=JSON.parse(cache);
        lastFilesSignature=sig;
        renderFilesTable();
      }else{
        if(!GOOGLE_SHEETS_FILES_URL){
          filesData=[
            {nome:"Esempio - Tema forum.zip",url:"#",size:"12 MB",hash:"ABC123",categoria:"Tema",note:"Esempio locale, collega il tuo foglio per dati reali.",sicurezza:"Sicuro"},
            {nome:"Strumento manutenzione.exe",url:"#",size:"3 MB",hash:"DEF456",categoria:"Tool",note:"Solo dimostrazione.",sicurezza:"Attenzione"}
          ];
          lastFilesSignature=signatureForFiles(filesData);
          renderFilesTable();
        }
      }
    }catch(e){}
  }
  async function fetchFilesFromSheet(){
    if(!GOOGLE_SHEETS_FILES_URL){
      document.getElementById("filesStatusLed").classList.remove("offline","sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesIdle;
      return filesData;
    }
    try{
      document.getElementById("filesStatusLed").classList.add("sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesSyncing;
      const res=await fetch(GOOGLE_SHEETS_FILES_URL);
      const text=await res.text();
      let data;
      try{
        data=JSON.parse(text);
      }catch(e){
        console.error("Adatta il parser al formato del tuo foglio.",e);
        return filesData;
      }
      const mapped=data.map(row=>({
        nome:row.nome||row.Nome||"",
        url:row.url||row.URL||"",
        size:row.size||row.peso||"",
        hash:row.hash||"",
        categoria:row.categoria||"",
        note:row.note||"",
        sicurezza:row.sicurezza||""
      }));
      return mapped;
    }catch(err){
      console.error("Errore caricamento file:",err);
      document.getElementById("filesStatusLed").classList.add("offline");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesOffline;
      return filesData;
    }
  }
  async function smartFilesUpdate(){
    const newFiles=await fetchFilesFromSheet();
    if(!newFiles || !Array.isArray(newFiles))return;
    const newSig=signatureForFiles(newFiles);
    if(newSig!==lastFilesSignature){
      filesData=newFiles;
      lastFilesSignature=newSig;
      renderFilesTable();
      document.getElementById("filesStatusLed").classList.remove("offline","sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesIdle;
      localStorage.setItem("matteoshare_files_cache",JSON.stringify(filesData));
      localStorage.setItem("matteoshare_files_signature",lastFilesSignature);
    }else{
      document.getElementById("filesStatusLed").classList.remove("offline","sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesIdle;
    }
  }

  async function fetchChatMessages(){
    try{
      document.getElementById("chatStatusLed").classList.add("sync");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatSyncing;
      const res=await fetch(GLOBAL_CHAT_ENDPOINT);
      const data=await res.json();
      chatMessages=Array.isArray(data)?data:[];
      renderChatMessages();
      document.getElementById("chatStatusLed").classList.remove("offline","sync");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatConnected;
    }catch(err){
      console.error("Errore chat globale:",err);
      document.getElementById("chatStatusLed").classList.add("offline");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatError;
    }
  }
  function renderChatMessages(){
    const container=document.getElementById("chatMessages");
    container.innerHTML="";
    chatMessages.forEach(msg=>{
      const div=document.createElement("div");
      div.className="chat-message";
      const header=document.createElement("div");
      header.className="chat-header";
      const userSpan=document.createElement("span");
      userSpan.className="chat-user";
      userSpan.textContent=msg.user||"Anonimo";
      const timeSpan=document.createElement("span");
      const ts=msg.timestamp?new Date(msg.timestamp):null;
      timeSpan.textContent=ts && !isNaN(ts.getTime())?ts.toLocaleString():"";
      header.appendChild(userSpan);
      header.appendChild(timeSpan);
      const body=document.createElement("div");
      body.textContent=msg.message||"";
      div.appendChild(header);
      div.appendChild(body);
      container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
    document.getElementById("chatMessagesCountValue").textContent=chatMessages.length.toString();
  }
  async function sendChatMessage(){
    const userInput=document.getElementById("chatUserInput");
    const msgInput=document.getElementById("chatMessageInput");
    const user=(userInput.value||"").trim()||(localAccount?localAccount.username:"Anonimo");
    const message=(msgInput.value||"").trim();
    if(!message)return;
    try{
      document.getElementById("chatStatusLed").classList.add("sync");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatSyncing;
      await fetch(GLOBAL_CHAT_ENDPOINT,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user,message})
      });
      msgInput.value="";
      await fetchChatMessages();
    }catch(err){
      console.error("Errore invio messaggio:",err);
      document.getElementById("chatStatusLed").classList.add("offline");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatError;
    }
  }

  document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("languageSelect").value=currentLanguage;
    applyLanguage(currentLanguage);
    document.getElementById("languageSelect").addEventListener("change",e=>{
      applyLanguage(e.target.value);
    });

    const acc=loadLocalAccount();
    if(acc){
      localAccount=acc;
      saveLocalAccount(acc);
      hideLoginOverlay();
    }else{
      showLoginOverlay();
    }

    document.getElementById("loginConfirmBtn").addEventListener("click",async()=>{
      const mode=document.getElementById("loginMode").value;
      const username=(document.getElementById("loginUsername").value||"").trim();
      const password=document.getElementById("loginPassword").value||"";
      const errorEl=document.getElementById("loginError");
      errorEl.style.display="none";
      errorEl.textContent="";
      if(!username || !password){
        errorEl.textContent="Inserisci nome utente e password.";
        errorEl.style.display="block";
        return;
      }
      const passHash=await hashPassword(password);
      const existing=loadLocalAccount();
      if(mode==="create"){
        const accObj={username,passwordHash:passHash,createdAt:Date.now()};
        saveLocalAccount(accObj);
        hideLoginOverlay();
      }else{
        if(!existing || existing.username!==username || existing.passwordHash!==passHash){
          errorEl.textContent="Credenziali non valide. Controlla nome utente e password.";
          errorEl.style.display="block";
          return;
        }
        saveLocalAccount(existing);
        hideLoginOverlay();
      }
    });

    document.getElementById("changeAccountBtn").addEventListener("click",()=>{
      localStorage.removeItem("matteoshare_account");
      localAccount=null;
      document.getElementById("accountNameLabel").textContent="-";
      document.getElementById("settingsAccountName").textContent="-";
      showLoginOverlay();
    });

    loadFilesFromCache();
    smartFilesUpdate();
    filesPollingInterval=setInterval(smartFilesUpdate,60000);

    fetchChatMessages();
    chatPollingInterval=setInterval(fetchChatMessages,5000);
    document.getElementById("chatSendBtn").addEventListener("click",sendChatMessage);
    document.getElementById("chatMessageInput").addEventListener("keydown",e=>{
      if(e.key==="Enter")sendChatMessage();
    });
  });
</script>
</body>
</html>
