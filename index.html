<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>MatteoShare · Social 3.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Tahoma,Segoe UI,system-ui,sans-serif;
      background:#008080 url("https://i.imgur.com/0vZ5F.png") repeat;
      color:#000;
    }
    .desktop{
      max-width:1100px;
      margin:20px auto;
    }
    .window{
      background:#c0c0c0;
      border:2px solid #000;
      border-right-color:#fff;
      border-bottom-color:#fff;
      box-shadow:2px 2px 0 #000;
      margin-bottom:14px;
    }
    .titlebar{
      background:linear-gradient(90deg,#000080,#1084d0);
      color:#fff;
      padding:3px 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      font-weight:bold;
    }
    .titlebar-buttons{
      display:flex;
      gap:2px;
    }
    .title-btn{
      width:16px;
      height:14px;
      border:1px solid #000;
      background:#c0c0c0;
      box-shadow:1px 1px 0 #fff inset, -1px -1px 0 #808080 inset;
      font-size:10px;
      text-align:center;
      line-height:12px;
      cursor:default;
    }
    .window-body{
      padding:6px;
      border-top:2px solid #fff;
      border-left:2px solid #fff;
      border-right:2px solid #808080;
      border-bottom:2px solid #808080;
      background:#e0e0e0;
      font-size:12px;
    }
    .menubar{
      display:flex;
      gap:10px;
      margin-bottom:6px;
      font-size:11px;
    }
    .menubar span{
      cursor:default;
    }
    .toolbar{
      margin-bottom:6px;
      padding:3px;
      border:2px solid #808080;
      border-right-color:#fff;
      border-bottom-color:#fff;
      background:#d4d0c8;
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }
    .toolbar button{
      font-size:11px;
      padding:2px 8px;
      border:2px solid #fff;
      border-right-color:#404040;
      border-bottom-color:#404040;
      background:#d4d0c8;
      cursor:pointer;
    }
    .toolbar button.active{
      background:#000080;
      color:#fff;
    }
    .main-layout{
      display:grid;
      grid-template-columns:2fr 1.4fr;
      gap:8px;
    }
    @media(max-width:900px){
      .main-layout{grid-template-columns:1fr}
    }
    .panel{
      border:2px solid #808080;
      border-right-color:#fff;
      border-bottom-color:#fff;
      background:#d4d0c8;
      padding:4px;
      margin-bottom:6px;
    }
    .panel-title{
      font-weight:bold;
      margin-bottom:4px;
      border-bottom:1px solid #808080;
      padding-bottom:2px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .status-strip{
      font-size:11px;
      margin-top:4px;
      padding:2px 4px;
      border-top:1px solid #fff;
      border-left:1px solid #fff;
      border-right:1px solid #808080;
      border-bottom:1px solid #808080;
      background:#d4d0c8;
      display:flex;
      justify-content:space-between;
    }
    .status-led{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      margin-right:4px;
      background:#0a0;
    }
    .status-led.offline{background:#a00}
    .status-led.sync{background:#cc0}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      background:#fff;
    }
    th,td{
      border:1px solid #808080;
      padding:3px 4px;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
    th{
      background:#000080;
      color:#fff;
      text-align:left;
    }
    tr:hover{
      background:#cfe7ff;
    }
    tr.selected{
      background:#99c0ff;
    }
    .tag{
      display:inline-block;
      padding:1px 4px;
      border:1px solid #808080;
      background:#e0e0e0;
      font-size:10px;
    }
    .tag.safe{background:#c0ffc0}
    .tag.warn{background:#fff0b3}
    .tag.danger{background:#ffc0c0}
    .file-detail{
      margin-top:4px;
      border:2px solid #808080;
      border-right-color:#fff;
      border-bottom-color:#fff;
      background:#d4d0c8;
      padding:4px;
      display:none;
    }
    .file-detail.visible{display:block}
    .file-detail h3{
      font-size:13px;
      margin-bottom:4px;
    }
    .file-meta{
      font-size:11px;
      margin-bottom:4px;
    }
    .file-meta span{
      display:inline-block;
      margin-right:8px;
    }
    .file-notes{
      font-size:11px;
      margin-bottom:4px;
    }
    .btn{
      font-size:11px;
      padding:2px 8px;
      border:2px solid #fff;
      border-right-color:#404040;
      border-bottom-color:#404040;
      background:#d4d0c8;
      cursor:pointer;
      margin-right:4px;
      margin-top:2px;
    }
    .btn-danger{
      background:#ffc0c0;
    }
    .news-item{
      border:1px solid #808080;
      background:#fff;
      padding:4px;
      margin-bottom:4px;
    }
    .news-title{
      font-weight:bold;
      margin-bottom:2px;
    }
    .news-meta{
      font-size:10px;
      color:#555;
      margin-bottom:2px;
    }
    .news-body{
      font-size:11px;
    }
    .chat-box{
      border:2px solid #808080;
      border-right-color:#fff;
      border-bottom-color:#fff;
      background:#fff;
      display:flex;
      flex-direction:column;
      height:260px;
    }
    .chat-messages{
      flex:1;
      padding:4px;
      overflow-y:auto;
      font-size:11px;
      background:#fff;
    }
    .chat-message{
      border-bottom:1px solid #e0e0e0;
      padding:2px 0;
    }
    .chat-header{
      display:flex;
      justify-content:space-between;
      font-size:10px;
      color:#555;
    }
    .chat-user{
      font-weight:bold;
    }
    .chat-input{
      border-top:1px solid #808080;
      padding:3px;
      background:#d4d0c8;
      display:flex;
      gap:4px;
    }
    .input,select{
      font-size:11px;
      padding:2px 4px;
      border:1px solid #808080;
      background:#fff;
      flex:1;
    }
    .input-small{
      max-width:120px;
    }
    .settings-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
      font-size:11px;
    }
    @media(max-width:700px){
      .settings-grid{grid-template-columns:1fr}
    }
    .settings-block{
      border:1px solid #808080;
      background:#fff;
      padding:4px;
    }
    .settings-title{
      font-weight:bold;
      margin-bottom:2px;
    }
    .settings-note{
      font-size:10px;
      color:#555;
      margin-top:2px;
    }
    .chip{
      display:inline-block;
      padding:1px 6px;
      border:1px solid #808080;
      background:#e0e0e0;
      font-size:10px;
      margin-right:3px;
      margin-top:2px;
    }
    .hidden{display:none!important}
    /* LOGIN WINDOW */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .login-window{
      width:320px;
    }
    .login-body{
      padding:8px;
      border-top:2px solid #fff;
      border-left:2px solid #fff;
      border-right:2px solid #808080;
      border-bottom:2px solid #808080;
      background:#e0e0e0;
      font-size:12px;
    }
    .login-body label{
      display:block;
      margin-top:4px;
      margin-bottom:2px;
      font-size:11px;
    }
    .login-actions{
      margin-top:6px;
      text-align:right;
    }
    .account-info{
      font-size:11px;
    }
  </style>
</head>
<body>
<div class="desktop">

  <!-- LOGIN / ACCOUNT LOCAL -->
  <div class="overlay" id="loginOverlay">
    <div class="window login-window">
      <div class="titlebar">
        <span>MatteoShare - Accesso account locale</span>
        <div class="titlebar-buttons">
          <div class="title-btn">?</div>
        </div>
      </div>
      <div class="login-body">
        <div style="margin-bottom:4px;">
          Benvenuto in <b>MatteoShare · Social 3.0</b>.<br>
          Crea o accedi a un <b>account locale</b> per usare il sito.
        </div>
        <label for="loginUsername">Nome utente</label>
        <input id="loginUsername" class="input" type="text" placeholder="Es. Matteo">
        <label for="loginMode">Modalità</label>
        <select id="loginMode" class="input">
          <option value="login">Accedi a un account esistente</option>
          <option value="create">Crea un nuovo account</option>
        </select>
        <div class="login-actions">
          <button class="btn" id="loginConfirmBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN WINDOW -->
  <div class="window">
    <div class="titlebar">
      <span>MatteoShare - Social 3.0</span>
      <div class="titlebar-buttons">
        <div class="title-btn">_</div>
        <div class="title-btn">□</div>
        <div class="title-btn">X</div>
      </div>
    </div>
    <div class="window-body">
      <div class="menubar">
        <span>File</span>
        <span>Modifica</span>
        <span>Visualizza</span>
        <span>Social</span>
        <span>Aiuto</span>
      </div>

      <div class="toolbar">
        <button class="active" data-tab="files" id="tabFilesBtn">File</button>
        <button data-tab="news" id="tabNewsBtn">News</button>
        <button data-tab="social" id="tabSocialBtn">Social 3.0</button>
        <button data-tab="settings" id="tabSettingsBtn">Impostazioni</button>
      </div>

      <div class="status-strip">
        <div>
          <span class="status-led" id="globalStatusLed"></span>
          <span id="globalStatusText">Sistema online · Account locale non configurato</span>
        </div>
        <div class="account-info">
          Utente: <span id="accountNameLabel">-</span>
        </div>
      </div>

      <div class="main-layout">
        <!-- LEFT SIDE -->
        <div>
          <!-- FILES PANEL -->
          <div class="panel tab-panel" data-tab-panel="files">
            <div class="panel-title">
              <span id="filesTitle">Archivio file collegato a Google Sheets</span>
              <span style="font-size:11px;" id="filesBadge">Foglio: nome, url, size, hash, categoria, note, sicurezza</span>
            </div>
            <table id="filesTable">
              <thead>
              <tr>
                <th id="thName">Nome</th>
                <th id="thCategory">Categoria</th>
                <th id="thSize">Peso</th>
                <th id="thSecurity">Sicurezza</th>
              </tr>
              </thead>
              <tbody id="filesTableBody">
              </tbody>
            </table>
            <div class="file-detail" id="fileDetail">
              <h3 id="fileDetailName">Seleziona un file…</h3>
              <div class="file-meta">
                <span id="fileDetailCategory"></span>
                <span id="fileDetailSize"></span>
                <span id="fileDetailHash"></span>
                <span id="fileDetailSecurity"></span>
              </div>
              <div class="file-notes" id="fileDetailNotes"></div>
              <div>
                <button class="btn" id="fileDownloadBtn">Scarica file</button>
                <button class="btn" id="fileOpenUrlBtn">Apri link diretto</button>
                <button class="btn btn-danger" id="fileReportBtn">Segnala file</button>
              </div>
            </div>
            <div class="status-strip">
              <div>
                <span class="status-led sync" id="filesStatusLed"></span>
                <span id="filesStatusText">Sincronizzazione intelligente in corso…</span>
              </div>
              <div>
                File: <span id="filesCountValue">0</span>
              </div>
            </div>
          </div>

          <!-- NEWS PANEL -->
          <div class="panel tab-panel hidden" data-tab-panel="news">
            <div class="panel-title">
              <span id="newsTitle">News & aggiornamenti</span>
              <span style="font-size:11px;" id="newsBadge">Social 3.0 · Sicurezza · Funzioni</span>
            </div>
            <div id="newsList">
              <!-- Static fallback, puoi collegare un foglio in JS -->
              <div class="news-item">
                <div class="news-title" id="newsItem1Title">Social 3.0 attivo</div>
                <div class="news-meta" id="newsItem1Meta">Chat globale collegata a Google Sheets</div>
                <div class="news-body" id="newsItem1Body">
                  La chat globale scrive e legge direttamente dal tuo foglio Google, con aggiornamento automatico.
                </div>
              </div>
              <div class="news-item">
                <div class="news-title" id="newsItem2Title">Sistema di auto update intelligente</div>
                <div class="news-meta" id="newsItem2Meta">Rilevamento modifiche sul foglio file</div>
                <div class="news-body" id="newsItem2Body">
                  L’archivio file si aggiorna quando rileva cambiamenti sul foglio, senza ricaricare il sito.
                </div>
              </div>
            </div>
            <div class="status-strip">
              <div>
                <span class="status-led" id="newsStatusLed"></span>
                <span id="newsStatusText">News statiche · Foglio news opzionale</span>
              </div>
              <div></div>
            </div>
          </div>
        </div>

        <!-- RIGHT SIDE -->
        <div>
          <!-- SOCIAL 3.0 / CHAT GLOBALE -->
          <div class="panel tab-panel" data-tab-panel="social">
            <div class="panel-title">
              <span id="socialTitle">Social 3.0 · Chat globale</span>
              <span style="font-size:11px;" id="socialBadge">Collegata a Google Sheets</span>
            </div>
            <div class="chat-box">
              <div class="chat-messages" id="chatMessages"></div>
              <div class="chat-input">
                <input id="chatUserInput" class="input input-small" placeholder="Nome utente">
                <input id="chatMessageInput" class="input" placeholder="Scrivi un messaggio globale…">
                <button class="btn" id="chatSendBtn">Invia</button>
              </div>
            </div>
            <div class="status-strip">
              <div>
                <span class="status-led" id="chatStatusLed"></span>
                <span id="chatStatusText">Chat globale connessa</span>
              </div>
              <div>
                Messaggi: <span id="chatMessagesCountValue">0</span>
              </div>
            </div>
          </div>

          <!-- SETTINGS -->
          <div class="panel tab-panel hidden" data-tab-panel="settings">
            <div class="panel-title">
              <span id="settingsTitle">Impostazioni</span>
              <span style="font-size:11px;" id="settingsBadge">Lingua · Social 3.0 · Sistema</span>
            </div>
            <div class="settings-grid">
              <div class="settings-block">
                <div class="settings-title" id="settingsLanguageLabel">Lingua interfaccia</div>
                <select id="languageSelect" class="input">
                  <option value="it">Italiano (predefinito)</option>
                  <option value="en">English</option>
                  <option value="ro">Română</option>
                  <option value="ru">Русский</option>
                </select>
                <div class="settings-note" id="settingsLanguageNote">
                  La lingua cambia solo l’interfaccia, non i contenuti dei file o della chat.
                </div>
              </div>
              <div class="settings-block">
                <div class="settings-title" id="settingsSystemLabel">Sistema</div>
                <div>
                  <span class="chip" id="chipAutoUpdate">Auto update intelligente</span>
                  <span class="chip" id="chipSocial">Social 3.0</span>
                  <span class="chip" id="chipSecurity">Monitor sicurezza</span>
                </div>
                <div class="settings-note" id="settingsSystemNote">
                  Il sistema controlla periodicamente i fogli Google per aggiornare file, news e chat senza ricaricare la pagina.
                </div>
              </div>
            </div>
            <div class="settings-block" style="margin-top:6px;">
              <div class="settings-title">Account locale</div>
              <div class="settings-note">
                Utente corrente: <b><span id="settingsAccountName">-</span></b><br>
                <button class="btn" id="changeAccountBtn">Cambia / reimposta account locale</button>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- main-layout -->
    </div>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  // Se vuoi collegare il foglio file, metti qui l'URL di export (JSON/CSV/gviz) e adatta il parser sotto.
  const GOOGLE_SHEETS_FILES_URL = ""; // opzionale, il sito funziona anche senza
  const GLOBAL_CHAT_ENDPOINT = "https://script.google.com/macros/s/AKfycbxMfTpIoNC6VVsFNO5JjX8SX0vwVFz2wLrTFRxcNlO6Kk8kA-hOZiJ1V3j0NJFKt_3F1A/exec";
  const FILE_REPORT_EMAIL = "report@matteoshare.local";

  // =========================
  // STATO
  // =========================
  let currentLanguage = localStorage.getItem("matteoshare_lang") || "it";
  let filesData = [];
  let lastFilesSignature = null;
  let selectedFileIndex = null;
  let chatMessages = [];
  let chatPollingInterval = null;
  let filesPollingInterval = null;
  let localAccount = null;

  // =========================
  // I18N
  // =========================
  const i18n = {
    it:{
      globalStatusNoAccount:"Sistema online · Account locale non configurato",
      globalStatusWithAccount:"Sistema online · Account locale attivo",
      filesTitle:"Archivio file collegato a Google Sheets",
      filesBadge:"Foglio: nome, url, size, hash, categoria, note, sicurezza",
      thName:"Nome",
      thCategory:"Categoria",
      thSize:"Peso",
      thSecurity:"Sicurezza",
      filesSyncing:"Sincronizzazione intelligente in corso…",
      filesIdle:"Archivio aggiornato",
      filesOffline:"Offline: uso cache locale",
      fileDetailPlaceholder:"Seleziona un file…",
      downloadBtn:"Scarica file",
      openBtn:"Apri link diretto",
      reportBtn:"Segnala file",
      newsTitle:"News & aggiornamenti",
      newsBadge:"Social 3.0 · Sicurezza · Funzioni",
      newsItem1Title:"Social 3.0 attivo",
      newsItem1Meta:"Chat globale collegata a Google Sheets",
      newsItem1Body:"La chat globale scrive e legge direttamente dal tuo foglio Google, con aggiornamento automatico.",
      newsItem2Title:"Sistema di auto update intelligente",
      newsItem2Meta:"Rilevamento modifiche sul foglio file",
      newsItem2Body:"L’archivio file si aggiorna quando rileva cambiamenti sul foglio, senza ricaricare il sito.",
      socialTitle:"Social 3.0 · Chat globale",
      socialBadge:"Collegata a Google Sheets",
      chatConnected:"Chat globale connessa",
      chatError:"Errore chat globale",
      chatSyncing:"Aggiornamento messaggi…",
      settingsTitle:"Impostazioni",
      settingsBadge:"Lingua · Social 3.0 · Sistema",
      settingsLanguageLabel:"Lingua interfaccia",
      settingsLanguageNote:"La lingua cambia solo l’interfaccia, non i contenuti dei file o della chat.",
      settingsSystemLabel:"Sistema",
      settingsSystemNote:"Il sistema controlla periodicamente i fogli Google per aggiornare file, news e chat senza ricaricare la pagina.",
      chipAutoUpdate:"Auto update intelligente",
      chipSocial:"Social 3.0",
      chipSecurity:"Monitor sicurezza"
    },
    en:{
      globalStatusNoAccount:"System online · Local account not configured",
      globalStatusWithAccount:"System online · Local account active",
      filesTitle:"File archive linked to Google Sheets",
      filesBadge:"Sheet: name, url, size, hash, category, note, security",
      thName:"Name",
      thCategory:"Category",
      thSize:"Size",
      thSecurity:"Security",
      filesSyncing:"Smart sync in progress…",
      filesIdle:"Archive up to date",
      filesOffline:"Offline: using local cache",
      fileDetailPlaceholder:"Select a file…",
      downloadBtn:"Download file",
      openBtn:"Open direct link",
      reportBtn:"Report file",
      newsTitle:"News & updates",
      newsBadge:"Social 3.0 · Security · Features",
      newsItem1Title:"Social 3.0 enabled",
      newsItem1Meta:"Global chat linked to Google Sheets",
      newsItem1Body:"Global chat writes and reads directly from your Google Sheet, with automatic updates.",
      newsItem2Title:"Smart auto update system",
      newsItem2Meta:"Change detection on files sheet",
      newsItem2Body:"The file archive updates when it detects changes on the sheet, without reloading the site.",
      socialTitle:"Social 3.0 · Global chat",
      socialBadge:"Linked to Google Sheets",
      chatConnected:"Global chat connected",
      chatError:"Global chat error",
      chatSyncing:"Updating messages…",
      settingsTitle:"Settings",
      settingsBadge:"Language · Social 3.0 · System",
      settingsLanguageLabel:"Interface language",
      settingsLanguageNote:"Language changes only the interface, not file or chat contents.",
      settingsSystemLabel:"System",
      settingsSystemNote:"The system periodically checks the sheets to update files, news and chat without reloading.",
      chipAutoUpdate:"Smart auto update",
      chipSocial:"Social 3.0",
      chipSecurity:"Security monitor"
    },
    ro:{
      globalStatusNoAccount:"Sistem online · Cont local neconfigurat",
      globalStatusWithAccount:"Sistem online · Cont local activ",
      filesTitle:"Arhivă fișiere legată de Google Sheets",
      filesBadge:"Foaie: nume, url, size, hash, categorie, note, securitate",
      thName:"Nume",
      thCategory:"Categorie",
      thSize:"Dimensiune",
      thSecurity:"Securitate",
      filesSyncing:"Sincronizare inteligentă…",
      filesIdle:"Arhivă actualizată",
      filesOffline:"Offline: folosesc cache local",
      fileDetailPlaceholder:"Selectează un fișier…",
      downloadBtn:"Descarcă fișier",
      openBtn:"Deschide link direct",
      reportBtn:"Raportează fișier",
      newsTitle:"Știri & actualizări",
      newsBadge:"Social 3.0 · Securitate · Funcții",
      newsItem1Title:"Social 3.0 activ",
      newsItem1Meta:"Chat global legat de Google Sheets",
      newsItem1Body:"Chatul global scrie și citește direct din Google Sheet, cu actualizare automată.",
      newsItem2Title:"Sistem de auto update inteligent",
      newsItem2Meta:"Detectare modificări în foaia de fișiere",
      newsItem2Body:"Arhiva de fișiere se actualizează când detectează modificări în foaie.",
      socialTitle:"Social 3.0 · Chat global",
      socialBadge:"Legat de Google Sheets",
      chatConnected:"Chat global conectat",
      chatError:"Eroare chat global",
      chatSyncing:"Actualizare mesaje…",
      settingsTitle:"Setări",
      settingsBadge:"Limbă · Social 3.0 · Sistem",
      settingsLanguageLabel:"Limba interfeței",
      settingsLanguageNote:"Limba schimbă doar interfața, nu conținutul fișierelor sau al chatului.",
      settingsSystemLabel:"Sistem",
      settingsSystemNote:"Sistemul verifică periodic foile pentru a actualiza fișierele, știrile și chatul fără reîncărcare.",
      chipAutoUpdate:"Auto update inteligent",
      chipSocial:"Social 3.0",
      chipSecurity:"Monitor securitate"
    },
    ru:{
      globalStatusNoAccount:"Система онлайн · Локальный аккаунт не настроен",
      globalStatusWithAccount:"Система онлайн · Локальный аккаунт активен",
      filesTitle:"Архив файлов, связанный с Google Sheets",
      filesBadge:"Лист: name, url, size, hash, category, note, security",
      thName:"Имя",
      thCategory:"Категория",
      thSize:"Размер",
      thSecurity:"Безопасность",
      filesSyncing:"Умная синхронизация…",
      filesIdle:"Архив актуален",
      filesOffline:"Оффлайн: используется локальный кэш",
      fileDetailPlaceholder:"Выберите файл…",
      downloadBtn:"Скачать файл",
      openBtn:"Открыть прямую ссылку",
      reportBtn:"Пожаловаться на файл",
      newsTitle:"Новости и обновления",
      newsBadge:"Social 3.0 · Безопасность · Функции",
      newsItem1Title:"Social 3.0 активен",
      newsItem1Meta:"Глобальный чат, связанный с Google Sheets",
      newsItem1Body:"Глобальный чат пишет и читает напрямую из Google Sheets с автообновлением.",
      newsItem2Title:"Система умного автообновления",
      newsItem2Meta:"Отслеживание изменений в листе файлов",
      newsItem2Body:"Архив файлов обновляется при изменениях в листе, без перезагрузки сайта.",
      socialTitle:"Social 3.0 · Глобальный чат",
      socialBadge:"Связан с Google Sheets",
      chatConnected:"Глобальный чат подключен",
      chatError:"Ошибка глобального чата",
      chatSyncing:"Обновление сообщений…",
      settingsTitle:"Настройки",
      settingsBadge:"Язык · Social 3.0 · Система",
      settingsLanguageLabel:"Язык интерфейса",
      settingsLanguageNote:"Язык меняет только интерфейс, не содержимое файлов или чата.",
      settingsSystemLabel:"Система",
      settingsSystemNote:"Система периодически проверяет листы, чтобы обновлять файлы, новости и чат без перезагрузки.",
      chipAutoUpdate:"Умное автообновление",
      chipSocial:"Social 3.0",
      chipSecurity:"Монитор безопасности"
    }
  };

  function applyLanguage(lang){
    const t=i18n[lang]||i18n.it;
    currentLanguage=lang;
    localStorage.setItem("matteoshare_lang",lang);

    document.getElementById("filesTitle").textContent=t.filesTitle;
    document.getElementById("filesBadge").textContent=t.filesBadge;
    document.getElementById("thName").textContent=t.thName;
    document.getElementById("thCategory").textContent=t.thCategory;
    document.getElementById("thSize").textContent=t.thSize;
    document.getElementById("thSecurity").textContent=t.thSecurity;
    document.getElementById("filesStatusText").textContent=t.filesIdle;
    document.getElementById("fileDetailName").textContent=t.fileDetailPlaceholder;
    document.getElementById("fileDownloadBtn").textContent=t.downloadBtn;
    document.getElementById("fileOpenUrlBtn").textContent=t.openBtn;
    document.getElementById("fileReportBtn").textContent=t.reportBtn;

    document.getElementById("newsTitle").textContent=t.newsTitle;
    document.getElementById("newsBadge").textContent=t.newsBadge;
    document.getElementById("newsItem1Title").textContent=t.newsItem1Title;
    document.getElementById("newsItem1Meta").textContent=t.newsItem1Meta;
    document.getElementById("newsItem1Body").textContent=t.newsItem1Body;
    document.getElementById("newsItem2Title").textContent=t.newsItem2Title;
    document.getElementById("newsItem2Meta").textContent=t.newsItem2Meta;
    document.getElementById("newsItem2Body").textContent=t.newsItem2Body;

    document.getElementById("socialTitle").textContent=t.socialTitle;
    document.getElementById("socialBadge").textContent=t.socialBadge;
    document.getElementById("chatStatusText").textContent=t.chatConnected;

    document.getElementById("settingsTitle").textContent=t.settingsTitle;
    document.getElementById("settingsBadge").textContent=t.settingsBadge;
    document.getElementById("settingsLanguageLabel").textContent=t.settingsLanguageLabel;
    document.getElementById("settingsLanguageNote").textContent=t.settingsLanguageNote;
    document.getElementById("settingsSystemLabel").textContent=t.settingsSystemLabel;
    document.getElementById("settingsSystemNote").textContent=t.settingsSystemNote;
    document.getElementById("chipAutoUpdate").textContent=t.chipAutoUpdate;
    document.getElementById("chipSocial").textContent=t.chipSocial;
    document.getElementById("chipSecurity").textContent=t.chipSecurity;

    updateGlobalStatus();
  }

  // =========================
  // ACCOUNT LOCALE
  // =========================
  function loadLocalAccount(){
    const raw=localStorage.getItem("matteoshare_account");
    if(!raw) return null;
    try{return JSON.parse(raw);}catch(e){return null;}
  }
  function saveLocalAccount(acc){
    localAccount=acc;
    localStorage.setItem("matteoshare_account",JSON.stringify(acc));
    document.getElementById("accountNameLabel").textContent=acc.username;
    document.getElementById("settingsAccountName").textContent=acc.username;
    const chatUserInput=document.getElementById("chatUserInput");
    if(chatUserInput && !chatUserInput.value) chatUserInput.value=acc.username;
    updateGlobalStatus();
  }
  function updateGlobalStatus(){
    const t=i18n[currentLanguage]||i18n.it;
    const led=document.getElementById("globalStatusLed");
    const label=document.getElementById("globalStatusText");
    led.classList.remove("offline","sync");
    if(localAccount){
      label.textContent=t.globalStatusWithAccount;
    }else{
      label.textContent=t.globalStatusNoAccount;
    }
  }

  function showLoginOverlay(){
    document.getElementById("loginOverlay").classList.remove("hidden");
  }
  function hideLoginOverlay(){
    document.getElementById("loginOverlay").classList.add("hidden");
  }

  // =========================
  // TABS
  // =========================
  document.querySelectorAll(".toolbar button").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".toolbar button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab=btn.getAttribute("data-tab");
      document.querySelectorAll(".tab-panel").forEach(p=>{
        p.classList.toggle("hidden",p.getAttribute("data-tab-panel")!==tab);
      });
    });
  });

  // =========================
  // FILES
  // =========================
  function signatureForFiles(files){
    return JSON.stringify(files.map(f=>({
      nome:f.nome,url:f.url,size:f.size,hash:f.hash,categoria:f.categoria,sicurezza:f.sicurezza,note:f.note
    })));
  }

  function renderFilesTable(){
    const tbody=document.getElementById("filesTableBody");
    tbody.innerHTML="";
    filesData.forEach((file,index)=>{
      const tr=document.createElement("tr");
      tr.dataset.index=index;
      if(index===selectedFileIndex) tr.classList.add("selected");

      const tdName=document.createElement("td");
      tdName.textContent=file.nome||"(senza nome)";
      const tdCat=document.createElement("td");
      tdCat.textContent=file.categoria||"-";
      const tdSize=document.createElement("td");
      tdSize.textContent=file.size||"-";
      const tdSec=document.createElement("td");
      const tag=document.createElement("span");
      tag.className="tag";
      const sec=(file.sicurezza||"").toLowerCase();
      if(sec.includes("sicuro")||sec.includes("safe")) tag.classList.add("safe");
      else if(sec.includes("attenzione")||sec.includes("warn")) tag.classList.add("warn");
      else if(sec.includes("pericoloso")||sec.includes("danger")) tag.classList.add("danger");
      tag.textContent=file.sicurezza||"-";
      tdSec.appendChild(tag);

      tr.appendChild(tdName);
      tr.appendChild(tdCat);
      tr.appendChild(tdSize);
      tr.appendChild(tdSec);

      tr.addEventListener("click",()=>{
        selectedFileIndex=index;
        document.querySelectorAll("#filesTableBody tr").forEach(r=>r.classList.remove("selected"));
        tr.classList.add("selected");
        renderFileDetail(file);
      });

      tbody.appendChild(tr);
    });
    document.getElementById("filesCountValue").textContent=filesData.length.toString();
  }

  function renderFileDetail(file){
    const t=i18n[currentLanguage]||i18n.it;
    const detail=document.getElementById("fileDetail");
    detail.classList.add("visible");
    document.getElementById("fileDetailName").textContent=file.nome||t.fileDetailPlaceholder;
    document.getElementById("fileDetailCategory").textContent=file.categoria?("Categoria: "+file.categoria):"";
    document.getElementById("fileDetailSize").textContent=file.size?("Peso: "+file.size):"";
    document.getElementById("fileDetailHash").textContent=file.hash?("Hash: "+file.hash):"";
    document.getElementById("fileDetailSecurity").textContent=file.sicurezza?("Sicurezza: "+file.sicurezza):"";
    document.getElementById("fileDetailNotes").textContent=file.note||"";

    const url=file.url||"";
    document.getElementById("fileDownloadBtn").onclick=()=>{if(url)window.open(url,"_blank");};
    document.getElementById("fileOpenUrlBtn").onclick=()=>{if(url)window.open(url,"_blank");};
    document.getElementById("fileReportBtn").onclick=()=>{
      const subject=encodeURIComponent("[MatteoShare] Segnalazione file: "+(file.nome||""));
      const body=encodeURIComponent(
        "Ciao,\n\nVorrei segnalare questo file:\n\n"+
        "Nome: "+(file.nome||"")+"\n"+
        "URL: "+(file.url||"")+"\n"+
        "Categoria: "+(file.categoria||"")+"\n"+
        "Peso: "+(file.size||"")+"\n"+
        "Sicurezza: "+(file.sicurezza||"")+"\n"+
        "Note: "+(file.note||"")+"\n\n"+
        "Motivo della segnalazione:\n[Scrivi qui]\n"
      );
      window.location.href=`mailto:${FILE_REPORT_EMAIL}?subject=${subject}&body=${body}`;
    };
  }

  function loadFilesFromCache(){
    try{
      const cache=localStorage.getItem("matteoshare_files_cache");
      const sig=localStorage.getItem("matteoshare_files_signature");
      if(cache && sig){
        filesData=JSON.parse(cache);
        lastFilesSignature=sig;
        renderFilesTable();
      }else{
        // fallback demo se non hai ancora collegato il foglio
        if(!GOOGLE_SHEETS_FILES_URL){
          filesData=[
            {nome:"Esempio - Tema XP.zip",url:"#",size:"12 MB",hash:"ABC123",categoria:"Tema",note:"Esempio locale, collega il tuo foglio per dati reali.",sicurezza:"Sicuro"},
            {nome:"Strumento manutenzione.exe",url:"#",size:"3 MB",hash:"DEF456",categoria:"Tool",note:"Solo dimostrazione.",sicurezza:"Attenzione"}
          ];
          lastFilesSignature=signatureForFiles(filesData);
          renderFilesTable();
        }
      }
    }catch(e){}
  }

  async function fetchFilesFromSheet(){
    if(!GOOGLE_SHEETS_FILES_URL){
      document.getElementById("filesStatusLed").classList.remove("offline","sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesIdle;
      return filesData;
    }
    try{
      document.getElementById("filesStatusLed").classList.add("sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesSyncing;
      const res=await fetch(GOOGLE_SHEETS_FILES_URL);
      const text=await res.text();

      // ADATTA QUI al formato del tuo export.
      // Esempio: se usi JSON diretto con chiavi nome,url,size,hash,categoria,note,sicurezza:
      let data;
      try{
        data=JSON.parse(text);
      }catch(e){
        console.error("Adatta il parser al formato del tuo foglio.",e);
        return filesData;
      }
      const mapped=data.map(row=>({
        nome:row.nome||row.Nome||"",
        url:row.url||row.URL||"",
        size:row.size||row.peso||"",
        hash:row.hash||"",
        categoria:row.categoria||"",
        note:row.note||"",
        sicurezza:row.sicurezza||""
      }));
      return mapped;
    }catch(err){
      console.error("Errore caricamento file:",err);
      document.getElementById("filesStatusLed").classList.add("offline");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesOffline;
      return filesData;
    }
  }

  async function smartFilesUpdate(){
    const newFiles=await fetchFilesFromSheet();
    if(!newFiles || !Array.isArray(newFiles))return;
    const newSig=signatureForFiles(newFiles);
    if(newSig!==lastFilesSignature){
      filesData=newFiles;
      lastFilesSignature=newSig;
      renderFilesTable();
      document.getElementById("filesStatusLed").classList.remove("offline","sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesIdle;
      localStorage.setItem("matteoshare_files_cache",JSON.stringify(filesData));
      localStorage.setItem("matteoshare_files_signature",lastFilesSignature);
    }else{
      document.getElementById("filesStatusLed").classList.remove("offline","sync");
      document.getElementById("filesStatusText").textContent=i18n[currentLanguage].filesIdle;
    }
  }

  // =========================
  // CHAT GLOBALE
  // =========================
  async function fetchChatMessages(){
    try{
      document.getElementById("chatStatusLed").classList.add("sync");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatSyncing;
      const res=await fetch(GLOBAL_CHAT_ENDPOINT);
      const data=await res.json();
      chatMessages=Array.isArray(data)?data:[];
      renderChatMessages();
      document.getElementById("chatStatusLed").classList.remove("offline","sync");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatConnected;
    }catch(err){
      console.error("Errore chat globale:",err);
      document.getElementById("chatStatusLed").classList.add("offline");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatError;
    }
  }

  function renderChatMessages(){
    const container=document.getElementById("chatMessages");
    container.innerHTML="";
    chatMessages.forEach(msg=>{
      const div=document.createElement("div");
      div.className="chat-message";
      const header=document.createElement("div");
      header.className="chat-header";
      const userSpan=document.createElement("span");
      userSpan.className="chat-user";
      userSpan.textContent=msg.user||"Anonimo";
      const timeSpan=document.createElement("span");
      const ts=msg.timestamp?new Date(msg.timestamp):null;
      timeSpan.textContent=ts && !isNaN(ts.getTime())?ts.toLocaleString():"";
      header.appendChild(userSpan);
      header.appendChild(timeSpan);
      const body=document.createElement("div");
      body.textContent=msg.message||"";
      div.appendChild(header);
      div.appendChild(body);
      container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
    document.getElementById("chatMessagesCountValue").textContent=chatMessages.length.toString();
  }

  async function sendChatMessage(){
    const userInput=document.getElementById("chatUserInput");
    const msgInput=document.getElementById("chatMessageInput");
    const user=(userInput.value||"").trim()||(localAccount?localAccount.username:"Anonimo");
    const message=(msgInput.value||"").trim();
    if(!message)return;
    try{
      document.getElementById("chatStatusLed").classList.add("sync");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatSyncing;
      await fetch(GLOBAL_CHAT_ENDPOINT,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user,message})
      });
      msgInput.value="";
      await fetchChatMessages();
    }catch(err){
      console.error("Errore invio messaggio:",err);
      document.getElementById("chatStatusLed").classList.add("offline");
      document.getElementById("chatStatusText").textContent=i18n[currentLanguage].chatError;
    }
  }

  // =========================
  // INIT
  // =========================
  document.addEventListener("DOMContentLoaded",()=>{
    // lingua
    document.getElementById("languageSelect").value=currentLanguage;
    applyLanguage(currentLanguage);
    document.getElementById("languageSelect").addEventListener("change",e=>{
      applyLanguage(e.target.value);
    });

    // account
    const acc=loadLocalAccount();
    if(acc){
      saveLocalAccount(acc);
      hideLoginOverlay();
    }else{
      showLoginOverlay();
    }

    document.getElementById("loginConfirmBtn").addEventListener("click",()=>{
      const username=(document.getElementById("loginUsername").value||"").trim();
      const mode=document.getElementById("loginMode").value;
      if(!username)return;
      const accObj={username,createdAt:Date.now(),mode};
      saveLocalAccount(accObj);
      hideLoginOverlay();
    });

    document.getElementById("changeAccountBtn").addEventListener("click",()=>{
      localStorage.removeItem("matteoshare_account");
      localAccount=null;
      document.getElementById("accountNameLabel").textContent="-";
      document.getElementById("settingsAccountName").textContent="-";
      showLoginOverlay();
    });

    // files
    loadFilesFromCache();
    smartFilesUpdate();
    filesPollingInterval=setInterval(smartFilesUpdate,60000);

    // chat
    fetchChatMessages();
    chatPollingInterval=setInterval(fetchChatMessages,5000);
    document.getElementById("chatSendBtn").addEventListener("click",sendChatMessage);
    document.getElementById("chatMessageInput").addEventListener("keydown",e=>{
      if(e.key==="Enter")sendChatMessage();
    });
  });
</script>
</body>
</html>
